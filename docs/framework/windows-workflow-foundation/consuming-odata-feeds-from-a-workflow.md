---
title: ワークフローからの OData フィードの使用-WF
ms.date: 03/30/2017
ms.assetid: 1b26617c-53e9-476a-81af-675c36d95919
ms.openlocfilehash: ceac2c2d07351fcb79e2345068f07fa22f356411
ms.sourcegitcommit: de17a7a0a37042f0d4406f5ae5393531caeb25ba
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/24/2020
ms.locfileid: "76743794"
---
# <a name="consuming-odata-feeds-from-a-workflow"></a><span data-ttu-id="f43aa-102">ワークフローからの OData フィードの使用</span><span class="sxs-lookup"><span data-stu-id="f43aa-102">Consuming OData feeds from a workflow</span></span>

<span data-ttu-id="f43aa-103">WCF Data Services は、Representational State Transfer (REST) のセマンティクスを使用して、Web またはイントラネット上のデータを公開および使用するための Open Data Protocol (OData) を使用するサービスを作成できるようにする、.NET Framework のコンポーネントです。</span><span class="sxs-lookup"><span data-stu-id="f43aa-103">WCF Data Services is a component of the .NET Framework that enables you to create services that use the Open Data Protocol (OData) to expose and consume data over the Web or intranet by using the semantics of representational state transfer (REST).</span></span> <span data-ttu-id="f43aa-104">OData は、URI でアドレス指定できるリソースとしてデータを公開します。</span><span class="sxs-lookup"><span data-stu-id="f43aa-104">OData exposes data as resources that are addressable by URIs.</span></span> <span data-ttu-id="f43aa-105">HTTP 要求を送信し、データ サービスが返す OData フィードを処理できるのであれば、どのようなアプリケーションでも OData ベースのデータ サービスと対話できます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-105">Any application can interact with an OData-based data service if it can send an HTTP request and process the OData feed that a data service returns.</span></span> <span data-ttu-id="f43aa-106">さらに、WCF Data Services には、.NET Framework アプリケーションから OData フィードを使用するときに、より高度なプログラミングエクスペリエンスを提供するクライアントライブラリが含まれています。</span><span class="sxs-lookup"><span data-stu-id="f43aa-106">In addition, WCF Data Services includes client libraries that provide a richer programming experience when you consume OData feeds from .NET Framework applications.</span></span> <span data-ttu-id="f43aa-107">このトピックでは、クライアント ライブラリを使用した場合と使用しない場合のワークフローでの OData フィードの使用の概要について説明します。</span><span class="sxs-lookup"><span data-stu-id="f43aa-107">This topic provides an overview of consuming an OData feed in a workflow with and without using the client libraries.</span></span>

## <a name="using-the-sample-northwind-odata-service"></a><span data-ttu-id="f43aa-108">サンプルの Northwind OData サービスの使用</span><span class="sxs-lookup"><span data-stu-id="f43aa-108">Using the sample Northwind OData service</span></span>

<span data-ttu-id="f43aa-109">このトピックの例では、<https://services.odata.org/Northwind/Northwind.svc/>にあるサンプルの Northwind データサービスを使用します。</span><span class="sxs-lookup"><span data-stu-id="f43aa-109">The examples in this topic use the sample Northwind data service located at <https://services.odata.org/Northwind/Northwind.svc/>.</span></span> <span data-ttu-id="f43aa-110">このサービスは [OData SDK](https://www.odata.org/ecosystem/#sdk) に含まれており、Northwind データベース サンプルへの読み取り専用アクセスを提供します。</span><span class="sxs-lookup"><span data-stu-id="f43aa-110">This service is provided as part of the [OData SDK](https://www.odata.org/ecosystem/#sdk) and provides read-only access to the sample Northwind database.</span></span> <span data-ttu-id="f43aa-111">書き込みアクセスが必要な場合、またはローカルの WCF Data Service が必要な場合は、「 [クイック スタート (WCF Data Services)](../data/wcf/quickstart-wcf-data-services.md) 」の手順に従って、Northwind データベースへのアクセスを提供するローカルの OData サービスを作成できます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-111">If write access is desired, or if a local WCF Data Service is desired, you can follow the steps of the [WCF Data Services Quickstart](../data/wcf/quickstart-wcf-data-services.md) to create a local OData service that provides access to the Northwind database.</span></span> <span data-ttu-id="f43aa-112">クイックスタートの手順に従う場合は、このトピックのコード例に指定されている URI をローカルの URI に置き換えてください。</span><span class="sxs-lookup"><span data-stu-id="f43aa-112">If you follow the quickstart, substitute the local URI for the one provided in the example code in this topic.</span></span>

## <a name="consuming-an-odata-feed-using-the-client-libraries"></a><span data-ttu-id="f43aa-113">クライアントライブラリを使用した OData フィードの使用</span><span class="sxs-lookup"><span data-stu-id="f43aa-113">Consuming an OData feed using the client libraries</span></span>

<span data-ttu-id="f43aa-114">WCF Data Services には、.NET Framework とクライアントアプリケーションから OData フィードを簡単に使用できるようにするクライアントライブラリが含まれています。</span><span class="sxs-lookup"><span data-stu-id="f43aa-114">WCF Data Services includes client libraries that enable you to more easily consume an OData feed from .NET Framework and client applications.</span></span> <span data-ttu-id="f43aa-115">これらのライブラリは、HTTP メッセージの送受信を簡略化します。</span><span class="sxs-lookup"><span data-stu-id="f43aa-115">These libraries simplify sending and receiving HTTP messages.</span></span> <span data-ttu-id="f43aa-116">また、メッセージ ペイロードをエンティティ データを表す CLR オブジェクトに変換します。</span><span class="sxs-lookup"><span data-stu-id="f43aa-116">They also translate the message payload into CLR objects that represent entity data.</span></span> <span data-ttu-id="f43aa-117">クライアント ライブラリには、 <xref:System.Data.Services.Client.DataServiceContext> および <xref:System.Data.Services.Client.DataServiceQuery%601>という 2 つのコア クラスがあります。</span><span class="sxs-lookup"><span data-stu-id="f43aa-117">The client libraries feature the two core classes <xref:System.Data.Services.Client.DataServiceContext> and <xref:System.Data.Services.Client.DataServiceQuery%601>.</span></span> <span data-ttu-id="f43aa-118">これらのクラスを使用すると、データ サービスをクエリして、返されるエンティティ データを CLR オブジェクトとして処理できます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-118">These classes enable you to query a data service and then work with the returned entity data as CLR objects.</span></span> <span data-ttu-id="f43aa-119">ここではクライアント ライブラリを使用するアクティビティを作成するための 2 つの方法を説明します。</span><span class="sxs-lookup"><span data-stu-id="f43aa-119">This section covers two approaches to creating activities that use the client libraries.</span></span>

### <a name="adding-a-service-reference-to-the-wcf-data-service"></a><span data-ttu-id="f43aa-120">WCF Data service へのサービス参照の追加</span><span class="sxs-lookup"><span data-stu-id="f43aa-120">Adding a service reference to the WCF Data service</span></span>

<span data-ttu-id="f43aa-121">Northwind クライアントライブラリを生成するには、Visual Studio 2012 の **[サービス参照の追加]** ダイアログボックスを使用して、northwind OData サービスへの参照を追加します。</span><span class="sxs-lookup"><span data-stu-id="f43aa-121">To generate the Northwind client libraries, you can use the **Add Service Reference** dialog box in Visual Studio 2012 to add a reference to the Northwind OData service.</span></span>

![[サービス参照の追加] ダイアログボックスが表示されたスクリーンショット。](./media/consuming-odata-feeds-from-a-workflow/add-service-reference-dialog.gif)

<span data-ttu-id="f43aa-123">サービスによって公開されるサービス操作はなく、 **[サービス]** ボックスの一覧には Northwind データ サービスによって公開されるエンティティを表す項目が含まれていることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="f43aa-123">Note that there are no service operations exposed by the service, and in the **Services** list there are items representing the entities exposed by the Northwind data service.</span></span> <span data-ttu-id="f43aa-124">サービス参照を追加すると、これらのエンティティに対するクラスが生成され、クライアント コードで使用できるようになります。</span><span class="sxs-lookup"><span data-stu-id="f43aa-124">When the service reference is added, classes will be generated for these entities and they can be used in the client code.</span></span> <span data-ttu-id="f43aa-125">このトピックの例ではこれらのクラスと `NorthwindEntities` クラスを使用してクエリを実行します。</span><span class="sxs-lookup"><span data-stu-id="f43aa-125">The examples in this topic use these classes and the `NorthwindEntities` class to perform the queries.</span></span>

> [!NOTE]
> <span data-ttu-id="f43aa-126">詳細については、「[データサービスクライアントライブラリの生成 (WCF Data Services)](../data/wcf/generating-the-data-service-client-library-wcf-data-services.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="f43aa-126">For more information, see [Generating the Data Service Client Library (WCF Data Services)](../data/wcf/generating-the-data-service-client-library-wcf-data-services.md).</span></span>

### <a name="using-asynchronous-methods"></a><span data-ttu-id="f43aa-127">非同期メソッドの使用</span><span class="sxs-lookup"><span data-stu-id="f43aa-127">Using asynchronous methods</span></span>

<span data-ttu-id="f43aa-128">Web のリソースにアクセスするときに発生することのある、待機時間に伴う問題に対処するために、WCF Data Services には非同期でアクセスすることをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="f43aa-128">To address possible latency issues that may occur when accessing resources over the Web, we recommend accessing WCF Data Services asynchronously.</span></span> <span data-ttu-id="f43aa-129">WCF Data Services クライアントライブラリには、クエリを呼び出すための非同期メソッドが含まれています。 Windows Workflow Foundation (WF) には、非同期アクティビティを作成するための <xref:System.Activities.AsyncCodeActivity> クラスが用意されています。</span><span class="sxs-lookup"><span data-stu-id="f43aa-129">The WCF Data Services client libraries include asynchronous methods for invoking queries, and Windows Workflow Foundation (WF) provides the <xref:System.Activities.AsyncCodeActivity> class for authoring asynchronous activities.</span></span> <span data-ttu-id="f43aa-130"><xref:System.Activities.AsyncCodeActivity> 派生アクティビティは、非同期メソッドを持つ .NET Framework クラスを利用するために記述できます。また、非同期に実行されるコードをメソッドに格納し、デリゲートを使用して呼び出すこともできます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-130"><xref:System.Activities.AsyncCodeActivity> derived activities can be written to take advantage of .NET Framework classes that have asynchronous methods, or the code to be executed asynchronously can be put into a method and invoked by using a delegate.</span></span> <span data-ttu-id="f43aa-131">ここでは、 <xref:System.Activities.AsyncCodeActivity> 派生アクティビティの例を 2 つ紹介します。1 つは WCF Data Services クライアント ライブラリの非同期メソッドを使用し、もう 1 つはデリゲートを使用しています。</span><span class="sxs-lookup"><span data-stu-id="f43aa-131">This section provides two examples of an <xref:System.Activities.AsyncCodeActivity> derived activity; one that uses the asynchronous methods of the WCF Data Services client libraries and one that uses a delegate.</span></span>

> [!NOTE]
> <span data-ttu-id="f43aa-132">詳細については、「[非同期操作 (WCF Data Services)](../data/wcf/asynchronous-operations-wcf-data-services.md) 」および「[非同期アクティビティの作成](creating-asynchronous-activities-in-wf.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="f43aa-132">For more information, see [Asynchronous Operations (WCF Data Services)](../data/wcf/asynchronous-operations-wcf-data-services.md) and [Creating Asynchronous Activities](creating-asynchronous-activities-in-wf.md).</span></span>

### <a name="using-client-library-asynchronous-methods"></a><span data-ttu-id="f43aa-133">クライアントライブラリの非同期メソッドの使用</span><span class="sxs-lookup"><span data-stu-id="f43aa-133">Using client library asynchronous methods</span></span>

<span data-ttu-id="f43aa-134"><xref:System.Data.Services.Client.DataServiceQuery%601> クラスには、OData サービスを非同期で照会するための <xref:System.Data.Services.Client.DataServiceQuery%601.BeginExecute%2A> メソッドと <xref:System.Data.Services.Client.DataServiceQuery%601.EndExecute%2A> メソッドが用意されています。</span><span class="sxs-lookup"><span data-stu-id="f43aa-134">The <xref:System.Data.Services.Client.DataServiceQuery%601> class provides <xref:System.Data.Services.Client.DataServiceQuery%601.BeginExecute%2A> and <xref:System.Data.Services.Client.DataServiceQuery%601.EndExecute%2A> methods for querying an OData service asynchronously.</span></span> <span data-ttu-id="f43aa-135">これらのメソッドは、 <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> 派生クラスの <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> オーバーライドと <xref:System.Activities.AsyncCodeActivity> オーバーライドから呼び出すことができます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-135">These methods can be called from the <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> and <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> overrides of an <xref:System.Activities.AsyncCodeActivity> derived class.</span></span> <span data-ttu-id="f43aa-136"><xref:System.Activities.AsyncCodeActivity> <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> のオーバーライドが返されると、ワークフローはアイドル状態になることがあります (永続化はできません)。また、非同期処理が完了すると、ランタイムによって <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> が呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-136">When the <xref:System.Activities.AsyncCodeActivity> <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> override returns, the workflow can go idle (but not persist), and when the asynchronous work is completed, <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> is invoked by the runtime.</span></span>

<span data-ttu-id="f43aa-137">次の例では、2 つの入力引数がある `OrdersByCustomer` アクティビティが定義されています。</span><span class="sxs-lookup"><span data-stu-id="f43aa-137">In the following example, an `OrdersByCustomer` activity is defined that has two input arguments.</span></span> <span data-ttu-id="f43aa-138">引数 `CustomerId` は、返す注文を識別する顧客を表し、引数 `ServiceUri` は、照会する OData サービスの URI を表します。</span><span class="sxs-lookup"><span data-stu-id="f43aa-138">The `CustomerId` argument represents the customer who identifies which orders to return, and the `ServiceUri` argument represents the URI of the OData service to be queried.</span></span> <span data-ttu-id="f43aa-139">アクティビティは `AsyncCodeActivity<IEnumerable<Order>>` から派生するので、クエリ結果を返すために使用される <xref:System.Activities.Activity%601.Result%2A> 出力引数も存在します。</span><span class="sxs-lookup"><span data-stu-id="f43aa-139">Because the activity derives from `AsyncCodeActivity<IEnumerable<Order>>` there is also a <xref:System.Activities.Activity%601.Result%2A> output argument that is used to return the results of the query.</span></span> <span data-ttu-id="f43aa-140"><xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> オーバーライドは、指定された顧客の注文をすべて選択する LINQ クエリを作成します。</span><span class="sxs-lookup"><span data-stu-id="f43aa-140">The <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> override creates a LINQ query that selects all orders of the specified customer.</span></span> <span data-ttu-id="f43aa-141">このクエリは、渡された <xref:System.Activities.AsyncCodeActivityContext.UserState%2A> の <xref:System.Activities.AsyncCodeActivityContext>として指定され、その後クエリの <xref:System.Data.Services.Client.DataServiceQuery%601.BeginExecute%2A> メソッドが呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-141">This query is specified as the <xref:System.Activities.AsyncCodeActivityContext.UserState%2A> of the passed <xref:System.Activities.AsyncCodeActivityContext>, and then the query's <xref:System.Data.Services.Client.DataServiceQuery%601.BeginExecute%2A> method is called.</span></span> <span data-ttu-id="f43aa-142">クエリの <xref:System.Data.Services.Client.DataServiceQuery%601.BeginExecute%2A> に渡されるコールバックと状態は、アクティビティの <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> メソッドに渡されるものであることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="f43aa-142">Note that the callback and state that are passed into the query's <xref:System.Data.Services.Client.DataServiceQuery%601.BeginExecute%2A> are the ones that are passed in to the activity's <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> method.</span></span> <span data-ttu-id="f43aa-143">クエリの実行が完了すると、アクティビティの <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> メソッドが呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-143">When the query has finished executing, the activity's <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> method is invoked.</span></span> <span data-ttu-id="f43aa-144">クエリは <xref:System.Activities.AsyncCodeActivityContext.UserState%2A>から取得され、その後クエリの <xref:System.Data.Services.Client.DataServiceQuery%601.EndExecute%2A> メソッドが呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-144">The query is retrieved from the <xref:System.Activities.AsyncCodeActivityContext.UserState%2A>, and then the query's <xref:System.Data.Services.Client.DataServiceQuery%601.EndExecute%2A> method is called.</span></span> <span data-ttu-id="f43aa-145">このメソッドは、指定されたエンティティ型の <xref:System.Collections.Generic.IEnumerable%601> を返します。この場合は `Order`になります。</span><span class="sxs-lookup"><span data-stu-id="f43aa-145">This method returns an <xref:System.Collections.Generic.IEnumerable%601> of the specified entity type; in this case `Order`.</span></span> <span data-ttu-id="f43aa-146">`IEnumerable<Order>` は <xref:System.Activities.AsyncCodeActivity%601>のジェネリック型であるため、この <xref:System.Collections.IEnumerable> はアクティビティの <xref:System.Activities.Activity%601.Result%2A> <xref:System.Activities.OutArgument%601> として設定されます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-146">Since `IEnumerable<Order>` is the generic type of the <xref:System.Activities.AsyncCodeActivity%601>, this <xref:System.Collections.IEnumerable> is set as the <xref:System.Activities.Activity%601.Result%2A> <xref:System.Activities.OutArgument%601> of the activity.</span></span>

[!code-csharp[CFX_WCFDataServicesActivityExample#100](~/samples/snippets/csharp/VS_Snippets_CFX/CFX_WCFDataServicesActivityExample/cs/Program.cs#100)]

<span data-ttu-id="f43aa-147">次の例では、指定された顧客の注文一覧を `OrdersByCustomer` アクティビティが取得した後、返された注文を <xref:System.Activities.Statements.ForEach%601> アクティビティが列挙し、各注文の日付をコンソールに書き込みます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-147">In the following example, the `OrdersByCustomer` activity retrieves a list of orders for the specified customer, and then a <xref:System.Activities.Statements.ForEach%601> activity enumerates the returned orders and writes the date of each order to the console.</span></span>

[!code-csharp[CFX_WCFDataServicesActivityExample#10](~/samples/snippets/csharp/VS_Snippets_CFX/CFX_WCFDataServicesActivityExample/cs/Program.cs#10)]

<span data-ttu-id="f43aa-148">このワークフローを呼び出すと、次のデータがコンソールに書き込まれます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-148">When this workflow is invoked, the following data is written to the console:</span></span>

```console
Calling WCF Data Service...
8/25/1997
10/3/1997
10/13/1997
1/15/1998
3/16/1998
4/9/1998
```

> [!NOTE]
> <span data-ttu-id="f43aa-149">OData サーバーへの接続を確立できない場合は、次のような例外が表示されます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-149">If a connection to the OData server cannot be established, you will get an exception similar to the following exception:</span></span>
>
> <span data-ttu-id="f43aa-150">ハンドルされていない例外: System.InvalidOperationException: この要求の処理中にエラーが発生しました。</span><span class="sxs-lookup"><span data-stu-id="f43aa-150">Unhandled Exception: System.InvalidOperationException: An error occurred while processing this request.</span></span> <span data-ttu-id="f43aa-151">---> System.Net.WebException: リモート サーバーに接続できません。---> System.Net.Sockets.SocketException: 接続済みの呼び出し先が一定の時間を過ぎても正しく応答しなかったため、接続できませんでした。または接続済みのホストが応答しなかったため、確立された接続は失敗しました。</span><span class="sxs-lookup"><span data-stu-id="f43aa-151">---> System.Net.WebException: Unable to connect to the remote server ---> System.Net.Sockets.SocketException: A connection attempt failed because the connected party did not properly respond after a period of time, or established connection failed because connected host has failed to respond.</span></span>

<span data-ttu-id="f43aa-152">クエリによって返されたデータをさらに処理する必要がある場合は、アクティビティの <xref:System.Activities.AsyncCodeActivity%601.EndExecute%2A> オーバーライドで実行できます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-152">If any additional processing of the data returned by the query is required, it can be done in the activity's <xref:System.Activities.AsyncCodeActivity%601.EndExecute%2A> override.</span></span> <span data-ttu-id="f43aa-153"><xref:System.Activities.AsyncCodeActivity%601.BeginExecute%2A> と <xref:System.Activities.AsyncCodeActivity%601.EndExecute%2A> はどちらもワークフロー スレッドを使用して呼び出されます。これらのオーバーライド内のコードは非同期では実行されません。</span><span class="sxs-lookup"><span data-stu-id="f43aa-153">Both <xref:System.Activities.AsyncCodeActivity%601.BeginExecute%2A> and <xref:System.Activities.AsyncCodeActivity%601.EndExecute%2A> are invoked by using the workflow thread, and any code in these overrides does not run asynchronously.</span></span> <span data-ttu-id="f43aa-154">追加の処理が大規模なものであるか、時間がかかるか、クエリ結果がページングされる場合は、次のセクションで説明する方法を検討してください。この方法では、デリゲートを使用してクエリを実行し、追加の処理を非同期で行います。</span><span class="sxs-lookup"><span data-stu-id="f43aa-154">If the additional processing is extensive or long-running, or the query results are paged, you should consider the approach discussed in the next section, which uses a delegate to execute the query and perform additional processing asynchronously.</span></span>

### <a name="using-a-delegate"></a><span data-ttu-id="f43aa-155">デリゲートの使用</span><span class="sxs-lookup"><span data-stu-id="f43aa-155">Using a delegate</span></span>

<span data-ttu-id="f43aa-156">.NET Framework クラスの非同期メソッドを呼び出すだけでなく、<xref:System.Activities.AsyncCodeActivity>ベースのアクティビティでは、そのメソッドのいずれかで非同期ロジックを定義することもできます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-156">In addition to invoking the asynchronous method of a .NET Framework class, an <xref:System.Activities.AsyncCodeActivity>-based activity can also define the asynchronous logic in one of its methods.</span></span> <span data-ttu-id="f43aa-157">このメソッドは、アクティビティの <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> オーバーライド内でデリゲートを使用することで指定します。</span><span class="sxs-lookup"><span data-stu-id="f43aa-157">This method is specified by using a delegate in the activity's <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> override.</span></span> <span data-ttu-id="f43aa-158">このメソッドが戻ると、ランタイムによってアクティビティの <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> オーバーライドが呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-158">When the method returns, the runtime invokes the activity's <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> override.</span></span> <span data-ttu-id="f43aa-159">OData サービスをワークフローから呼び出すときは、このメソッドを使用してサービスを照会し、追加の処理を実行できます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-159">When calling an OData service from a workflow, this method can be used to query the service and provide any additional processing.</span></span>

<span data-ttu-id="f43aa-160">次の例では、 `ListCustomers` アクティビティを定義します。</span><span class="sxs-lookup"><span data-stu-id="f43aa-160">In the following example, a `ListCustomers` activity is defined.</span></span> <span data-ttu-id="f43aa-161">このアクティビティは、Northwind データ サービス サンプルを照会し、Northwind データベース内の顧客をすべて含む `List<Customer>` を返します。</span><span class="sxs-lookup"><span data-stu-id="f43aa-161">This activity queries the sample Northwind data service and returns a `List<Customer>` that contains all of the customers in the Northwind database.</span></span> <span data-ttu-id="f43aa-162">非同期操作は `GetCustomers` メソッドによって実行されます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-162">The asynchronous work is performed by the `GetCustomers` method.</span></span> <span data-ttu-id="f43aa-163">このメソッドは、サービスに対してすべての顧客を照会し、これらの顧客を `List<Customer>`にコピーします。</span><span class="sxs-lookup"><span data-stu-id="f43aa-163">This method queries the service for all customers, and then copies them into a `List<Customer>`.</span></span> <span data-ttu-id="f43aa-164">次に、結果がページングされているかどうかを確認します。</span><span class="sxs-lookup"><span data-stu-id="f43aa-164">It then checks to see if the results are paged.</span></span> <span data-ttu-id="f43aa-165">ページングされている場合は、サービスに対して結果の次のページを照会し、それを一覧に追加します。処理は顧客データをすべて取得するまで続行されます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-165">If so, it queries the service for the next page of results, adds them to the list, and continues until all of the customer data has been retrieved.</span></span>

> [!NOTE]
> <span data-ttu-id="f43aa-166">WCF Data Services でのページングの詳細については、「[方法: ページングされた結果を読み込む (WCF Data Services)](../data/wcf/how-to-load-paged-results-wcf-data-services.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="f43aa-166">For more information about paging in WCF Data Services, see [How to: Load Paged Results (WCF Data Services)](../data/wcf/how-to-load-paged-results-wcf-data-services.md).</span></span>

<span data-ttu-id="f43aa-167">顧客がすべて追加されると、一覧が返されます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-167">Once all customers are added, the list is returned.</span></span> <span data-ttu-id="f43aa-168">`GetCustomers` メソッドはアクティビティの <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> オーバーライドで指定されます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-168">The `GetCustomers` method is specified in the activity's <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> override.</span></span> <span data-ttu-id="f43aa-169">メソッドには戻り値があるので、メソッドを指定するために `Func<string, List<Customer>>` が作成されます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-169">Since the method has a return value, a `Func<string, List<Customer>>` is created to specify the method.</span></span>

> [!NOTE]
> <span data-ttu-id="f43aa-170">非同期操作を実行するメソッドに戻り値がない場合は、<xref:System.Action> の代わりに <xref:System.Func%601> が使用されます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-170">If the method that performs the asynchronous work does not have a return value, an <xref:System.Action> is used instead of a <xref:System.Func%601>.</span></span> <span data-ttu-id="f43aa-171">両方の方法を使用して非同期の例を作成する例については、「[非同期アクティビティの作成](creating-asynchronous-activities-in-wf.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="f43aa-171">For examples of creating an asynchronous example using both approaches, see [Creating Asynchronous Activities](creating-asynchronous-activities-in-wf.md).</span></span>

<span data-ttu-id="f43aa-172">この <xref:System.Func%601> は <xref:System.Activities.AsyncCodeActivityContext.UserState%2A> に割り当てられ、`BeginInvoke` が呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-172">This <xref:System.Func%601> is assigned to the <xref:System.Activities.AsyncCodeActivityContext.UserState%2A>, and then `BeginInvoke` is called.</span></span> <span data-ttu-id="f43aa-173">呼び出すメソッドはアクティビティの引数の環境にアクセスできないので、引数 `ServiceUri` 値は <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A>に渡されたコールバックおよび状態と共に、最初のパラメーターとして渡されます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-173">Since the method to be invoked does not have access to the activity's environment of arguments, the value of the `ServiceUri` argument is passed as the first parameter, together with the callback and state that were passed into <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A>.</span></span> <span data-ttu-id="f43aa-174">`GetCustomers` が戻ると、ランタイムによって <xref:System.Activities.AsyncCodeActivity.EndExecute%2A>が呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-174">When `GetCustomers` returns, the runtime invokes <xref:System.Activities.AsyncCodeActivity.EndExecute%2A>.</span></span> <span data-ttu-id="f43aa-175"><xref:System.Activities.AsyncCodeActivity.EndExecute%2A> 内のコードはデリゲートを <xref:System.Activities.AsyncCodeActivityContext.UserState%2A>から取得し、 `EndInvoke`を呼び出し、結果を返します。この結果は、 `GetCustomers` メソッドから返された顧客の一覧です。</span><span class="sxs-lookup"><span data-stu-id="f43aa-175">The code in <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> retrieves the delegate from the <xref:System.Activities.AsyncCodeActivityContext.UserState%2A>, calls `EndInvoke`, and returns the result, which is the list of customers returned from the `GetCustomers` method.</span></span>

[!code-csharp[CFX_WCFDataServicesActivityExample#200](~/samples/snippets/csharp/VS_Snippets_CFX/CFX_WCFDataServicesActivityExample/cs/Program.cs#200)]

<span data-ttu-id="f43aa-176">次の例では、顧客の一覧を `ListCustomers` アクティビティが取得した後、その一覧を <xref:System.Activities.Statements.ForEach%601> アクティビティが列挙し、各顧客の会社名と連絡先名をコンソールに書き込みます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-176">In the following example, the `ListCustomers` activity retrieves a list of customers, and then a <xref:System.Activities.Statements.ForEach%601> activity enumerates them and writes the company name and contact name of each customer to the console.</span></span>

[!code-csharp[CFX_WCFDataServicesActivityExample#20](~/samples/snippets/csharp/VS_Snippets_CFX/CFX_WCFDataServicesActivityExample/cs/Program.cs#20)]

<span data-ttu-id="f43aa-177">このワークフローを呼び出すと、次のデータがコンソールに書き込まれます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-177">When this workflow is invoked, the following data is written to the console.</span></span> <span data-ttu-id="f43aa-178">このクエリは多くの顧客を返すので、ここでは出力の一部のみが表示されています。</span><span class="sxs-lookup"><span data-stu-id="f43aa-178">Since this query returns many customers, only part of the output is displayed here.</span></span>

```console
Calling WCF Data Service...
Alfreds Futterkiste, Contact: Maria Anders
Ana Trujillo Emparedados y helados, Contact: Ana Trujillo
Antonio Moreno Taquería, Contact: Antonio Moreno
Around the Horn, Contact: Thomas Hardy
Berglunds snabbköp, Contact: Christina Berglund
...
```

## <a name="consuming-an-odata-feed-without-using-the-client-libraries"></a><span data-ttu-id="f43aa-179">クライアントライブラリを使用せずに OData フィードを使用する</span><span class="sxs-lookup"><span data-stu-id="f43aa-179">Consuming an OData feed without using the client libraries</span></span>

<span data-ttu-id="f43aa-180">OData は、URI でアドレス指定できるリソースとしてデータを公開します。</span><span class="sxs-lookup"><span data-stu-id="f43aa-180">OData exposes data as resources that are addressable by URIs.</span></span> <span data-ttu-id="f43aa-181">クライアント ライブラリを使用するとこれらの URI が自動的に作成されますが、必ずしもクライアント ライブラリを使用する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="f43aa-181">When you use the client libraries these URIs are created for you, but you do not have to use the client libraries.</span></span> <span data-ttu-id="f43aa-182">OData サービスはクライアント ライブラリを使用せずに直接アクセスすることもできます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-182">If desired, OData services can be accessed directly without using the client libraries.</span></span> <span data-ttu-id="f43aa-183">クライアント ライブラリを使用しない場合、サービスの場所と必要なデータは URI によって指定され、結果が HTTP 要求への応答の中で返されます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-183">When not using the client libraries the location of the service and the desired data are specified by the URI and the results are returned in the response to the HTTP request.</span></span> <span data-ttu-id="f43aa-184">この生データはその後自由に処理または操作できます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-184">This raw data can then be processed or manipulated in the desired manner.</span></span> <span data-ttu-id="f43aa-185">OData クエリの結果を取得する方法の 1 つとして、 <xref:System.Net.WebClient> クラスを使用する方法があります。</span><span class="sxs-lookup"><span data-stu-id="f43aa-185">One way to retrieve the results of an OData query is by using the <xref:System.Net.WebClient> class.</span></span> <span data-ttu-id="f43aa-186">この例では、キー ALFKI が表す顧客の連絡先名が取得されます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-186">In this example, the contact name for the customer represented by the key ALFKI is retrieved.</span></span>

[!code-csharp[CFX_WCFDataServicesActivityExample#2](~/samples/snippets/csharp/VS_Snippets_CFX/CFX_WCFDataServicesActivityExample/cs/Program.cs#2)]

<span data-ttu-id="f43aa-187">このコードが実行されると、次の出力がコンソールに表示されます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-187">When this code is run, the following output is displayed to the console:</span></span>

```console
Raw data returned:
<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<ContactName xmlns="http://schemas.microsoft.com/ado/2007/08/dataservices">Maria Anders</ContactName>
```

<span data-ttu-id="f43aa-188">ワークフローでは、この例のコードを <xref:System.Activities.CodeActivity.Execute%2A> ベースのカスタム アクティビティの <xref:System.Activities.CodeActivity> オーバーライドに組み込むことができますが、<xref:System.Activities.Expressions.InvokeMethod%601> アクティビティを使用して同じ機能を実行することもできます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-188">In a workflow, the code from this example could be incorporated into the <xref:System.Activities.CodeActivity.Execute%2A> override of a <xref:System.Activities.CodeActivity>-based custom activity, but the same functionality can also be accomplished by using the <xref:System.Activities.Expressions.InvokeMethod%601> activity.</span></span> <span data-ttu-id="f43aa-189"><xref:System.Activities.Expressions.InvokeMethod%601> アクティビティは、ワークフローの作成者がクラスの静的メソッドやインスタンス メソッドを呼び出すことができるようにします。また、指定したメソッドを非同期で呼び出すオプションもあります。</span><span class="sxs-lookup"><span data-stu-id="f43aa-189">The <xref:System.Activities.Expressions.InvokeMethod%601> activity enables workflow authors to invoke static and instance methods of a class, and also has an option to invoke the specified method asynchronously.</span></span> <span data-ttu-id="f43aa-190">次の例では、 <xref:System.Activities.Expressions.InvokeMethod%601> アクティビティは <xref:System.Net.WebClient.DownloadString%2A> クラスの <xref:System.Net.WebClient> メソッドを呼び出して顧客一覧を返すように構成されています。</span><span class="sxs-lookup"><span data-stu-id="f43aa-190">In the following example, an <xref:System.Activities.Expressions.InvokeMethod%601> activity is configured to call the <xref:System.Net.WebClient.DownloadString%2A> method of the <xref:System.Net.WebClient> class and return a list of customers.</span></span>

[!code-csharp[CFX_WCFDataServicesActivityExample#3](~/samples/snippets/csharp/VS_Snippets_CFX/CFX_WCFDataServicesActivityExample/cs/Program.cs#3)]

<span data-ttu-id="f43aa-191"><xref:System.Activities.Expressions.InvokeMethod%601> は、クラスの静的メソッドとインスタンス メソッドの両方を呼び出すことができます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-191"><xref:System.Activities.Expressions.InvokeMethod%601> can call both static and instance methods of a class.</span></span> <span data-ttu-id="f43aa-192"><xref:System.Net.WebClient.DownloadString%2A> は <xref:System.Net.WebClient> クラスのインスタンス メソッドであるため、 <xref:System.Net.WebClient> のために <xref:System.Activities.Expressions.InvokeMethod%601.TargetObject%2A>クラスの新規インスタンスが指定されます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-192">Since <xref:System.Net.WebClient.DownloadString%2A> is an instance method of the <xref:System.Net.WebClient> class, a new instance of the <xref:System.Net.WebClient> class is specified for the <xref:System.Activities.Expressions.InvokeMethod%601.TargetObject%2A>.</span></span> <span data-ttu-id="f43aa-193">`DownloadString` は <xref:System.Activities.Expressions.InvokeMethod%601.MethodName%2A>として指定され、クエリを含む URI は <xref:System.Activities.Expressions.InvokeMethod%601.Parameters%2A> のコレクションで指定され、戻り値が <xref:System.Activities.Activity%601.Result%2A> の値に指定されます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-193">`DownloadString` is specified as the <xref:System.Activities.Expressions.InvokeMethod%601.MethodName%2A>, the URI that contains the query is specified in the <xref:System.Activities.Expressions.InvokeMethod%601.Parameters%2A> collection, and the return value is assigned to the <xref:System.Activities.Activity%601.Result%2A> value.</span></span> <span data-ttu-id="f43aa-194"><xref:System.Activities.Expressions.InvokeMethod%601.RunAsynchronously%2A> 値は `true`に設定されます。これは、ワークフローに関するメソッドの呼び出しが非同期で実行されることを意味します。</span><span class="sxs-lookup"><span data-stu-id="f43aa-194">The <xref:System.Activities.Expressions.InvokeMethod%601.RunAsynchronously%2A> value is set to `true`, which means that the method invocation will run asynchronously with regard to the workflow.</span></span> <span data-ttu-id="f43aa-195">次の例では、 <xref:System.Activities.Expressions.InvokeMethod%601> アクティビティを使用するワークフローが作成され、Northwind データ サービス サンプルに対して特定の顧客の注文一覧が照会されます。返されたデータはコンソールに書き込まれます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-195">In the following example, a workflow is constructed that uses the <xref:System.Activities.Expressions.InvokeMethod%601> activity to query the sample Northwind data service for a list of orders for a specific customer, and then the returned data is written to the console.</span></span>

[!code-csharp[CFX_WCFDataServicesActivityExample#1](~/samples/snippets/csharp/VS_Snippets_CFX/CFX_WCFDataServicesActivityExample/cs/Program.cs#1)]

<span data-ttu-id="f43aa-196">このワークフローが呼び出されると、次の出力がコンソールに表示されます。</span><span class="sxs-lookup"><span data-stu-id="f43aa-196">When this workflow is invoked, the following output is displayed to the console.</span></span> <span data-ttu-id="f43aa-197">このクエリは複数の注文を返すので、ここでは出力の一部のみが表示されています。</span><span class="sxs-lookup"><span data-stu-id="f43aa-197">Since this query returns several orders, only part of the output is displayed here.</span></span>

```console
Calling WCF Data Service...
Raw data returned:

<?xml version="1.0" encoding="utf-8" standalone="yes"?>*
<feed
xml:base="http://services.odata.org/Northwind/Northwind.svc/"
xmlns:d="http://schemas.microsoft.com/ado/2007/08/dataservices"
xmlns:m="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata"
xmlns="http://www.w3.org/2005/Atom">
<title type="text">Orders\</title>
<id>http://services.odata.org/Northwind/Northwind.svc/Customers('ALFKI')/Orders\</id>
<updated>2010-05-19T19:37:07Z\</updated>
<link rel="self" title="Orders" href="Orders" />
<entry>
<id>http://services.odata.org/Northwind/Northwind.svc/Orders(10643)\</id>
<title type="text">\</title>
<updated>2010-05-19T19:37:07Z\</updated>
<author>
<name />
</author>
<link rel="edit" title="Order" href="Orders(10643)" />
<link rel="http://schemas.microsoft.com/ado/2007/08/dataservices/related/Customer" type="application/atom+xml;type=entry" title="Customer" href="Orders(10643)/Customer" />
...
```

<span data-ttu-id="f43aa-198">この例は、ワークフロー アプリケーションの作成者が OData サービスから返された生データを使用できる方法の 1 つを示しています。</span><span class="sxs-lookup"><span data-stu-id="f43aa-198">This example provides one method that workflow application authors can use to consume the raw data returned from an OData service.</span></span> <span data-ttu-id="f43aa-199">Uri を使用した WCF Data Services へのアクセスの詳細については、「[データサービスリソースへのアクセス (WCF Data Services)](../data/wcf/accessing-data-service-resources-wcf-data-services.md) 」および「 [OData: URI 規則](https://www.odata.org/documentation/odata-version-2-0/uri-conventions/)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="f43aa-199">For more information about accessing WCF Data Services using URIs, see [Accessing Data Service Resources (WCF Data Services)](../data/wcf/accessing-data-service-resources-wcf-data-services.md) and [OData: URI Conventions](https://www.odata.org/documentation/odata-version-2-0/uri-conventions/).</span></span>
