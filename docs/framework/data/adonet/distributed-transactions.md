---
title: 分散トランザクション
ms.date: 03/30/2017
ms.assetid: 718b257c-bcb2-408e-b004-a7b0adb1c176
ms.openlocfilehash: 143d39356f444bfc3c899164c43c9608a4aab335
ms.sourcegitcommit: d2e1dfa7ef2d4e9ffae3d431cf6a4ffd9c8d378f
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/07/2019
ms.locfileid: "70795199"
---
# <a name="distributed-transactions"></a><span data-ttu-id="708a7-102">分散トランザクション</span><span class="sxs-lookup"><span data-stu-id="708a7-102">Distributed Transactions</span></span>
<span data-ttu-id="708a7-103">トランザクションとは、たとえば、1 つの単位として成功 (コミット) または失敗 (アボート) する関連タスク セットです。</span><span class="sxs-lookup"><span data-stu-id="708a7-103">A transaction is a set of related tasks that either succeeds (commit) or fails (abort) as a unit, among other things.</span></span> <span data-ttu-id="708a7-104">*分散トランザクション*は、複数のリソースに影響を与えるトランザクションです。</span><span class="sxs-lookup"><span data-stu-id="708a7-104">A *distributed transaction* is a transaction that affects several resources.</span></span> <span data-ttu-id="708a7-105">分散トランザクションがコミットされるためには、すべての参加要素が、すべてのデータ変更が永久的な変更となることを保証する必要があります。</span><span class="sxs-lookup"><span data-stu-id="708a7-105">For a distributed transaction to commit, all participants must guarantee that any change to data will be permanent.</span></span> <span data-ttu-id="708a7-106">システム クラッシュその他の予期しない出来事が発生した場合でも、変更は保持されます。</span><span class="sxs-lookup"><span data-stu-id="708a7-106">Changes must persist despite system crashes or other unforeseen events.</span></span> <span data-ttu-id="708a7-107">1 つの参加要素がこの保証に失敗しただけでも、トランザクション全体が失敗し、トランザクションのスコープ内のデータに対する変更がロールバックされます。</span><span class="sxs-lookup"><span data-stu-id="708a7-107">If even a single participant fails to make this guarantee, the entire transaction fails, and any changes to data within the scope of the transaction are rolled back.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="708a7-108">トランザクションがアクティブであるときに `DataReader` が開始された場合、トランザクションをコミットまたはロールバックしようとすると例外がスローされます。</span><span class="sxs-lookup"><span data-stu-id="708a7-108">An exception will be thrown if you attempt to commit or roll back a transaction if a `DataReader` is started while the transaction is active.</span></span>  
  
## <a name="working-with-systemtransactions"></a><span data-ttu-id="708a7-109">System.Transactions の操作</span><span class="sxs-lookup"><span data-stu-id="708a7-109">Working with System.Transactions</span></span>  
 <span data-ttu-id="708a7-110">.NET Framework では、分散トランザクションは <xref:System.Transactions> 名前空間内の API を介して管理されます。</span><span class="sxs-lookup"><span data-stu-id="708a7-110">In the .NET Framework, distributed transactions are managed through the API in the <xref:System.Transactions> namespace.</span></span> <span data-ttu-id="708a7-111">複数の永続的なリソース マネージャーが関係する場合、<xref:System.Transactions> API は分散トランザクション処理を Microsoft Distributed Transaction Coordinator (MS DTC) などのトランザクション モニターに委任します。</span><span class="sxs-lookup"><span data-stu-id="708a7-111">The <xref:System.Transactions> API will delegate distributed transaction handling to a transaction monitor such as the Microsoft Distributed Transaction Coordinator (MS DTC) when multiple persistent resource managers are involved.</span></span> <span data-ttu-id="708a7-112">詳細については、「[トランザクションの基礎](../transactions/transaction-fundamentals.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="708a7-112">For more information, see [Transaction Fundamentals](../transactions/transaction-fundamentals.md).</span></span>  
  
 <span data-ttu-id="708a7-113">ADO.NET 2.0 では、`EnlistTransaction` メソッドを使用した分散トランザクションへの参加のサポートが導入されました。これにより、接続を <xref:System.Transactions.Transaction> インスタンスに参加させることができます。</span><span class="sxs-lookup"><span data-stu-id="708a7-113">ADO.NET 2.0 introduced support for enlisting in a distributed transaction using the `EnlistTransaction` method, which enlists a connection in a <xref:System.Transactions.Transaction> instance.</span></span> <span data-ttu-id="708a7-114">ADO.NET の以前のバージョンでは、分散トランザクションへの明示的な参加は、接続の `EnlistDistributedTransaction` メソッドを使用して実行されていました。これによって <xref:System.EnterpriseServices.ITransaction> インスタンス内の接続を参加させることで、下位互換性を得ることができます。</span><span class="sxs-lookup"><span data-stu-id="708a7-114">In previous versions of ADO.NET, explicit enlistment in distributed transactions was performed using the `EnlistDistributedTransaction` method of a connection to enlist a connection in a <xref:System.EnterpriseServices.ITransaction> instance, which is supported for backwards compatibility.</span></span> <span data-ttu-id="708a7-115">エンタープライズサービストランザクションの詳細については、「[エンタープライズサービスと COM + トランザクションの相互運用性](../transactions/interoperability-with-enterprise-services-and-com-transactions.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="708a7-115">For more information on Enterprise Services transactions, see [Interoperability with Enterprise Services and COM+ Transactions](../transactions/interoperability-with-enterprise-services-and-com-transactions.md).</span></span>  
  
 <span data-ttu-id="708a7-116">.NET Framework Provider for SQL Server で SQL Server データベースに対して <xref:System.Transactions> トランザクションを使用する場合は、軽量な <xref:System.Transactions.Transaction> が自動的に使用されます。</span><span class="sxs-lookup"><span data-stu-id="708a7-116">When using a <xref:System.Transactions> transaction with the .NET Framework Provider for SQL Server against a SQL Server database, a lightweight <xref:System.Transactions.Transaction> will automatically be used.</span></span> <span data-ttu-id="708a7-117">トランザクションは、必要に応じて完全な分散トランザクションに昇格させることができます。</span><span class="sxs-lookup"><span data-stu-id="708a7-117">The transaction can then be promoted to a full distributed transaction on an as-needed basis.</span></span> <span data-ttu-id="708a7-118">詳細については、「 [SQL Server とのシステムトランザクションの統合](system-transactions-integration-with-sql-server.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="708a7-118">For more information, see [System.Transactions Integration with SQL Server](system-transactions-integration-with-sql-server.md).</span></span>  
  
> [!NOTE]
> <span data-ttu-id="708a7-119">既定では、1 つの Oracle データベースが一度に参加できる分散トランザクションの最大数は 10 に設定されています。</span><span class="sxs-lookup"><span data-stu-id="708a7-119">The maximum number of distributed transactions that an Oracle database can participate in at one time is set to 10 by default.</span></span> <span data-ttu-id="708a7-120">Oracle データベースに接続している場合、トランザクション数が 10 個を超えると例外がスローされます。</span><span class="sxs-lookup"><span data-stu-id="708a7-120">After the 10th transaction when connected to an Oracle database, an exception is thrown.</span></span> <span data-ttu-id="708a7-121">Oracle では、分散トランザクション内での `DDL` はサポートされません。</span><span class="sxs-lookup"><span data-stu-id="708a7-121">Oracle does not support `DDL` inside of a distributed transaction.</span></span>  
  
## <a name="automatically-enlisting-in-a-distributed-transaction"></a><span data-ttu-id="708a7-122">分散トランザクションへの自動参加</span><span class="sxs-lookup"><span data-stu-id="708a7-122">Automatically Enlisting in a Distributed Transaction</span></span>  
 <span data-ttu-id="708a7-123">自動参加は、ADO.NET 接続を `System.Transactions` に統合する場合の既定の (推奨される) 方法です。</span><span class="sxs-lookup"><span data-stu-id="708a7-123">Automatic enlistment is the default (and preferred) way of integrating ADO.NET connections with `System.Transactions`.</span></span> <span data-ttu-id="708a7-124">接続オブジェクトは、トランザクションがアクティブであると判定されると、既存の分散トランザクションに自動的に参加します。トランザクションがアクティブであることは、`System.Transaction` から見ると、`Transaction.Current` が null でないことを意味します。</span><span class="sxs-lookup"><span data-stu-id="708a7-124">A connection object will automatically enlist in an existing distributed transaction if it determines that a transaction is active, which, in `System.Transaction` terms, means that `Transaction.Current` is not null.</span></span> <span data-ttu-id="708a7-125">自動トランザクション参加は、接続が開かれた場合に行われます。</span><span class="sxs-lookup"><span data-stu-id="708a7-125">Automatic transaction enlistment occurs when the connection is opened.</span></span> <span data-ttu-id="708a7-126">その後は、コマンドがトランザクションのスコープ内で実行された場合でも、自動トランザクション参加は行われません。</span><span class="sxs-lookup"><span data-stu-id="708a7-126">It will not happen after that even if a command is executed inside of a transaction scope.</span></span> <span data-ttu-id="708a7-127">`Enlist=false` の接続文字列パラメーターとして <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A?displayProperty=nameWithType> を指定するか、`OLE DB Services=-7` の接続文字パラメーターとして <xref:System.Data.OleDb.OleDbConnection.ConnectionString%2A?displayProperty=nameWithType> を指定すると、既存のトランザクションへの自動参加を無効にできます。</span><span class="sxs-lookup"><span data-stu-id="708a7-127">You can disable auto-enlistment in existing transactions by specifying `Enlist=false` as a connection string parameter for a <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A?displayProperty=nameWithType>, or `OLE DB Services=-7` as a connection string parameter for an <xref:System.Data.OleDb.OleDbConnection.ConnectionString%2A?displayProperty=nameWithType>.</span></span> <span data-ttu-id="708a7-128">Oracle および ODBC 接続文字列パラメーターの詳細については、「<xref:System.Data.OracleClient.OracleConnection.ConnectionString%2A?displayProperty=nameWithType>」および「<xref:System.Data.Odbc.OdbcConnection.ConnectionString%2A?displayProperty=nameWithType>」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="708a7-128">For more information on Oracle and ODBC connection string parameters, see <xref:System.Data.OracleClient.OracleConnection.ConnectionString%2A?displayProperty=nameWithType> and <xref:System.Data.Odbc.OdbcConnection.ConnectionString%2A?displayProperty=nameWithType>.</span></span>  
  
## <a name="manually-enlisting-in-a-distributed-transaction"></a><span data-ttu-id="708a7-129">手動による分散トランザクションへの参加</span><span class="sxs-lookup"><span data-stu-id="708a7-129">Manually Enlisting in a Distributed Transaction</span></span>  
 <span data-ttu-id="708a7-130">自動参加が無効になっている場合、または接続が開いた後に開始したトランザクションに参加する必要がある場合は、使用中のプロバイダーの `EnlistTransaction` オブジェクトの <xref:System.Data.Common.DbConnection> メソッドを使用して、既存の分散トランザクションに参加できます。</span><span class="sxs-lookup"><span data-stu-id="708a7-130">If auto-enlistment is disabled or you need to enlist a transaction that was started after the connection was opened, you can enlist in an existing distributed transaction using the `EnlistTransaction` method of the <xref:System.Data.Common.DbConnection> object for the provider you are working with.</span></span> <span data-ttu-id="708a7-131">既存の分散トランザクションに参加すると、トランザクションがコミットまたはロールバックされた場合、データ ソースに対してコードで行った変更もコミットまたはロールバックされます。</span><span class="sxs-lookup"><span data-stu-id="708a7-131">Enlisting in an existing distributed transaction ensures that, if the transaction is committed or rolled back, modifications made by the code at the data source will be committed or rolled back as well.</span></span>  
  
 <span data-ttu-id="708a7-132">分散トランザクションへの参加は、特にビジネス オブジェクトをプールする場合に適切です。</span><span class="sxs-lookup"><span data-stu-id="708a7-132">Enlisting in distributed transactions is particularly applicable when pooling business objects.</span></span> <span data-ttu-id="708a7-133">ビジネス オブジェクトが、開かれている接続と共にプールされている場合は、その接続を開くときだけ、自動トランザクション参加が行われます。</span><span class="sxs-lookup"><span data-stu-id="708a7-133">If a business object is pooled with an open connection, automatic transaction enlistment only occurs when that connection is opened.</span></span> <span data-ttu-id="708a7-134">プールされているビジネス オブジェクトを使用して複数のトランザクションが実行される場合、そのオブジェクトの開かれている接続は、新しく開始されるトランザクションには自動参加しません。</span><span class="sxs-lookup"><span data-stu-id="708a7-134">If multiple transactions are performed using the pooled business object, the open connection for that object will not automatically enlist in newly initiated transactions.</span></span> <span data-ttu-id="708a7-135">この場合には、接続の自動トランザクション参加を無効にし、`EnlistTransaction` を使用して、接続をトランザクションに参加させることができます。</span><span class="sxs-lookup"><span data-stu-id="708a7-135">In this case, you can disable automatic transaction enlistment for the connection and enlist the connection in transactions using `EnlistTransaction`.</span></span>  
  
 <span data-ttu-id="708a7-136">`EnlistTransaction`は、既存のトランザクションへ<xref:System.Transactions.Transaction>の参照である型の単一の引数を受け取ります。</span><span class="sxs-lookup"><span data-stu-id="708a7-136">`EnlistTransaction` takes a single argument of type <xref:System.Transactions.Transaction> that is a reference to the existing transaction.</span></span> <span data-ttu-id="708a7-137">接続の `EnlistTransaction` メソッドを呼び出した後、接続を使用してデータ ソースに対して行ったすべての変更は、トランザクションに組み込まれます。</span><span class="sxs-lookup"><span data-stu-id="708a7-137">After calling the connection's `EnlistTransaction` method, all modifications made at the data source using the connection are included in the transaction.</span></span> <span data-ttu-id="708a7-138">null 値を渡すことで、現在の分散トランザクションから接続の参加が解除されます。</span><span class="sxs-lookup"><span data-stu-id="708a7-138">Passing a null value unenlists the connection from its current distributed transaction enlistment.</span></span> <span data-ttu-id="708a7-139">この接続は、`EnlistTransaction` を呼び出す前に開く必要があることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="708a7-139">Note that the connection must be opened before calling `EnlistTransaction`.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="708a7-140">一度接続を明示的にトランザクションに参加させると、最初のトランザクションが終了するまでは、参加を解除したり別のトランザクションに参加させたりすることはできません。</span><span class="sxs-lookup"><span data-stu-id="708a7-140">Once a connection is explicitly enlisted on a transaction, it cannot be un-enlisted or enlisted in another transaction until the first transaction finishes.</span></span>  
  
> [!CAUTION]
> <span data-ttu-id="708a7-141">接続の `EnlistTransaction` メソッドを使用してトランザクションが既に開始していた場合、<xref:System.Data.Common.DbConnection.BeginTransaction%2A> は例外をスローします。</span><span class="sxs-lookup"><span data-stu-id="708a7-141">`EnlistTransaction` throws an exception if the connection has already begun a transaction using the connection's <xref:System.Data.Common.DbConnection.BeginTransaction%2A> method.</span></span> <span data-ttu-id="708a7-142">ただし、トランザクションがデータ ソースで開始されたローカル トランザクションである場合 (たとえば <xref:System.Data.SqlClient.SqlCommand> を使用して BEGIN TRANSACTION ステートメントを明示的に実行した場合)、`EnlistTransaction` はローカル トランザクションをロールバックし、要求されたように既存の分散トランザクションに参加します。</span><span class="sxs-lookup"><span data-stu-id="708a7-142">However, if the transaction is a local transaction started at the data source (for example, executing the BEGIN TRANSACTION statement explicitly using a <xref:System.Data.SqlClient.SqlCommand>), `EnlistTransaction` will roll back the local transaction and enlist in the existing distributed transaction as requested.</span></span> <span data-ttu-id="708a7-143">ローカル トランザクションがロールバックされたことは通知されないため、<xref:System.Data.Common.DbConnection.BeginTransaction%2A> を使用して開始したのではないローカル トランザクションについては、自分で管理する必要があります。</span><span class="sxs-lookup"><span data-stu-id="708a7-143">You will not receive notice that the local transaction was rolled back, and must manage any local transactions not started using <xref:System.Data.Common.DbConnection.BeginTransaction%2A>.</span></span> <span data-ttu-id="708a7-144">.NET Framework Data Provider for SQL Server (`SqlClient`) を SQL Server で使用する場合は、参加を試みると例外がスローされます。</span><span class="sxs-lookup"><span data-stu-id="708a7-144">If you are using the .NET Framework Data Provider for SQL Server (`SqlClient`) with SQL Server, an attempt to enlist will throw an exception.</span></span> <span data-ttu-id="708a7-145">その他の場合については検出されません。</span><span class="sxs-lookup"><span data-stu-id="708a7-145">All other cases will go undetected.</span></span>  
  
## <a name="promotable-transactions-in-sql-server"></a><span data-ttu-id="708a7-146">SQL Server の昇格可能なトランザクション</span><span class="sxs-lookup"><span data-stu-id="708a7-146">Promotable Transactions in SQL Server</span></span>  
 <span data-ttu-id="708a7-147">SQL Server は、軽量のローカル トランザクションを必要に応じて分散トランザクションに自動的に昇格できる、昇格可能なトランザクションをサポートしています。</span><span class="sxs-lookup"><span data-stu-id="708a7-147">SQL Server supports promotable transactions in which a local lightweight transaction can be automatically promoted to a distributed transaction only if it is required.</span></span> <span data-ttu-id="708a7-148">昇格可能なトランザクションは、必要な場合以外、分散トランザクションのオーバーヘッドの増加を引き起こすことはありません。</span><span class="sxs-lookup"><span data-stu-id="708a7-148">A promotable transaction does not invoke the added overhead of a distributed transaction unless the added overhead is required.</span></span> <span data-ttu-id="708a7-149">詳細とコードサンプルについては、「 [SQL Server とのシステムトランザクション統合](system-transactions-integration-with-sql-server.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="708a7-149">For more information and a code sample, see [System.Transactions Integration with SQL Server](system-transactions-integration-with-sql-server.md).</span></span>  
  
## <a name="configuring-distributed-transactions"></a><span data-ttu-id="708a7-150">分散トランザクションの設定</span><span class="sxs-lookup"><span data-stu-id="708a7-150">Configuring Distributed Transactions</span></span>  
 <span data-ttu-id="708a7-151">分散トランザクションを使用するには、ネットワーク上の MS DTC を有効にする必要があります。</span><span class="sxs-lookup"><span data-stu-id="708a7-151">You may need to enable the MS DTC over the network in order to use distributed transactions.</span></span> <span data-ttu-id="708a7-152">Windows ファイアウォールを有効にしている場合は、MS DTC サービスでネットワークを使用するか MS DTC ポートを開くことができるようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="708a7-152">If have the Windows Firewall enabled, you must allow the MS DTC service to use the network or open the MS DTC port.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="708a7-153">関連項目</span><span class="sxs-lookup"><span data-stu-id="708a7-153">See also</span></span>

- [<span data-ttu-id="708a7-154">トランザクションと同時実行</span><span class="sxs-lookup"><span data-stu-id="708a7-154">Transactions and Concurrency</span></span>](transactions-and-concurrency.md)
- [<span data-ttu-id="708a7-155">SQL Server と System.Transactions の統合</span><span class="sxs-lookup"><span data-stu-id="708a7-155">System.Transactions Integration with SQL Server</span></span>](system-transactions-integration-with-sql-server.md)
- [<span data-ttu-id="708a7-156">ADO.NET の概要</span><span class="sxs-lookup"><span data-stu-id="708a7-156">ADO.NET Overview</span></span>](ado-net-overview.md)
