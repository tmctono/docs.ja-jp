---
title: ユーザー コード トレースの出力
ms.date: 03/30/2017
ms.assetid: fa54186a-8ffa-4332-b0e7-63867126fd49
ms.openlocfilehash: e8b2031165a83e24ba15a2fcf847a170f47e696a
ms.sourcegitcommit: cdb295dd1db589ce5169ac9ff096f01fd0c2da9d
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/09/2020
ms.locfileid: "84589293"
---
# <a name="emitting-user-code-traces"></a><span data-ttu-id="295c6-102">ユーザー コード トレースの出力</span><span class="sxs-lookup"><span data-stu-id="295c6-102">Emitting User-Code Traces</span></span>

<span data-ttu-id="295c6-103">Windows Communication Foundation (WCF) によって生成されたインストルメンテーションデータを収集するように構成でトレースを有効にするだけでなく、ユーザーコードでトレースをプログラムによって出力することもできます。</span><span class="sxs-lookup"><span data-stu-id="295c6-103">In addition to enabling tracing in configuration to collect instrumentation data generated by Windows Communication Foundation (WCF), you can also emit traces programmatically in user code.</span></span> <span data-ttu-id="295c6-104">この方法では、インストルメンテーション データを能動的に作成でき、後でそのデータを診断目的で詳細に調べることができます。</span><span class="sxs-lookup"><span data-stu-id="295c6-104">In this way, you can proactively create instrumentation data that you can peruse later for diagnostic purpose.</span></span> <span data-ttu-id="295c6-105">ここでは、この方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="295c6-105">This topic discusses how you can do this.</span></span>

<span data-ttu-id="295c6-106">さらに、[トレースの拡張](../../samples/extending-tracing.md)サンプルには、次のセクションに示すすべてのコードが含まれています。</span><span class="sxs-lookup"><span data-stu-id="295c6-106">In addition, the [Extending Tracing](../../samples/extending-tracing.md) sample includes all the code demonstrated in the following sections.</span></span>

## <a name="creating-a-trace-source"></a><span data-ttu-id="295c6-107">トレース ソースの作成</span><span class="sxs-lookup"><span data-stu-id="295c6-107">Creating a Trace Source</span></span>

<span data-ttu-id="295c6-108">ユーザー トレース ソースを作成するには、次のコードを使用できます。</span><span class="sxs-lookup"><span data-stu-id="295c6-108">You can use the following code to create a user trace source.</span></span>

```csharp
TraceSource ts = new TraceSource("myUserTraceSource");
```

## <a name="creating-activities"></a><span data-ttu-id="295c6-109">アクティビティの作成</span><span class="sxs-lookup"><span data-stu-id="295c6-109">Creating Activities</span></span>

<span data-ttu-id="295c6-110">アクティビティは論理的な処理単位です。</span><span class="sxs-lookup"><span data-stu-id="295c6-110">Activities are logical unit of processing.</span></span> <span data-ttu-id="295c6-111">トレースをグループ化する主要な処理単位ごとに 1 つのアクティビティを作成できます。</span><span class="sxs-lookup"><span data-stu-id="295c6-111">You can create one activity for each major processing unit in which you want traces to be grouped together.</span></span> <span data-ttu-id="295c6-112">たとえば、サービスの要求ごとに 1 つのアクティビティを作成できます。</span><span class="sxs-lookup"><span data-stu-id="295c6-112">For example, you can create one activity for each request to the service.</span></span> <span data-ttu-id="295c6-113">これを行うには、次の手順を実行します。</span><span class="sxs-lookup"><span data-stu-id="295c6-113">To do so, perform the following steps.</span></span>

1. <span data-ttu-id="295c6-114">スコープでアクティブ ID を保存します。</span><span class="sxs-lookup"><span data-stu-id="295c6-114">Save the activity ID in scope.</span></span>

2. <span data-ttu-id="295c6-115">新しいアクティビティ ID を作成します。</span><span class="sxs-lookup"><span data-stu-id="295c6-115">Create a new activity ID.</span></span>

3. <span data-ttu-id="295c6-116">スコープ内のアクティビティから新しいアクティビティに移り、スコープ内に新しいアクティビティを設定し、そのアクティビティの Start トレースを出力します。</span><span class="sxs-lookup"><span data-stu-id="295c6-116">Transfer from the activity in scope to the new one, set the new activity in scope and emit a start trace for that activity.</span></span>

<span data-ttu-id="295c6-117">次のコードでは、この設定方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="295c6-117">The following code demonstrates how to do this.</span></span>

```csharp
Guid oldID = Trace.CorrelationManager.ActivityId;
Guid traceID = Guid.NewGuid();
ts.TraceTransfer(0, "transfer", traceID);
Trace.CorrelationManager.ActivityId = traceID; // Trace is static
ts.TraceEvent(TraceEventType.Start, 0, "Add request");
```

## <a name="emitting-traces-within-a-user-activity"></a><span data-ttu-id="295c6-118">ユーザー アクティビティ内でのトレースの出力</span><span class="sxs-lookup"><span data-stu-id="295c6-118">Emitting Traces within a User Activity</span></span>

<span data-ttu-id="295c6-119">ユーザー アクティビティ内でトレースを出力するコードを次に示します。</span><span class="sxs-lookup"><span data-stu-id="295c6-119">The following code emits traces within a user activity.</span></span>

```csharp
double value1 = 100.00D;
double value2 = 15.99D;
ts.TraceInformation("Client sends message to Add " + value1 + ", " + value2);
double result = client.Add(value1, value2);
ts.TraceInformation("Client receives Add response '" + result + "'");
```

## <a name="stopping-the-activities"></a><span data-ttu-id="295c6-120">アクティビティの停止</span><span class="sxs-lookup"><span data-stu-id="295c6-120">Stopping the Activities</span></span>

<span data-ttu-id="295c6-121">アクティビティを停止するには、旧アクティビティに戻り、現在のアクティビティ ID を停止して、スコープで旧アクティビティをリセットします。</span><span class="sxs-lookup"><span data-stu-id="295c6-121">To stop the activities, transfer back to the old activity, stop the current activity id, and reset the old activity id in scope.</span></span>

<span data-ttu-id="295c6-122">次のコードでは、この設定方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="295c6-122">The following code demonstrates how to do this.</span></span>

```csharp
ts.TraceTransfer(0, "transfer", oldID);
ts.TraceEvent(TraceEventType.Stop, 0, "Add request");
Trace.CorrelationManager.ActivityId = oldID;
```

## <a name="propagating-the-activity-id-to-a-service"></a><span data-ttu-id="295c6-123">サービスへのアクティビティ ID の伝達</span><span class="sxs-lookup"><span data-stu-id="295c6-123">Propagating the Activity ID to A Service</span></span>

<span data-ttu-id="295c6-124">クライアントとサービスの両方の構成ファイルで、`propagateActivity` トレース ソースの `true` 属性を `System.ServiceModel` に設定した場合、Add 要求に対するサービス処理は、クライアントに定義されたものと同じアクティビティで発生します。</span><span class="sxs-lookup"><span data-stu-id="295c6-124">If you set the `propagateActivity` attribute to `true` for the `System.ServiceModel` trace source in both the client and service configuration files, the service processing for the Add request occurs in the same activity as the one defined in the client.</span></span> <span data-ttu-id="295c6-125">サービスに独自のアクティビティと転送が定義されている場合、そのサービス トレースは、クライアントにより伝達されたアクティビティには表示されません。</span><span class="sxs-lookup"><span data-stu-id="295c6-125">If the service defines its own activities and transfers, the service traces do not appear in the client-propagated activity.</span></span> <span data-ttu-id="295c6-126">その代わり、クライアントから ID が伝達されたアクティビティに、転送トレースにより、関連付けられたアクティビティにサービス トレースが表示されます。</span><span class="sxs-lookup"><span data-stu-id="295c6-126">Instead, they appear in an activity correlated by transfer traces to the activity whose ID is propagated by the client.</span></span>

> [!NOTE]
> <span data-ttu-id="295c6-127">`propagateActivity`クライアントとサービスの両方で属性がに設定されている場合 `true` 、サービスの操作スコープのアンビエントアクティビティは WCF によって設定されます。</span><span class="sxs-lookup"><span data-stu-id="295c6-127">If the `propagateActivity` attribute is set to `true` on both the client and service, the ambient activity in the operation scope of the service is set by WCF.</span></span>

<span data-ttu-id="295c6-128">次のコードを使用して、アクティビティが WCF によってスコープに設定されているかどうかを確認できます。</span><span class="sxs-lookup"><span data-stu-id="295c6-128">You can use the following code to check whether an activity was set in scope by WCF.</span></span>

```csharp
// Check if an activity was set in scope by WCF, if it was
// propagated from the client. If not, ( ambient activity is
// equal to Guid.Empty), create a new one.
if(Trace.CorrelationManager.ActivityId == Guid.Empty)
{
    Guid newGuid = Guid.NewGuid();
    Trace.CorrelationManager.ActivityId = newGuid;
}
// Emit your Start trace.
ts.TraceEvent(TraceEventType.Start, 0, "Add Activity");

// Emit the processing traces for that request.
serviceTs.TraceInformation("Service receives Add "
                            + n1 + ", " + n2);
// double result = n1 + n2;
serviceTs.TraceInformation("Service sends Add result" + result);

// Emit the Stop trace and exit the method scope.
ts.TraceEvent(TraceEventType.Stop, 0, "Add Activity");
// return result;
```

## <a name="tracing-exceptions-thrown-in-code"></a><span data-ttu-id="295c6-129">コード内でスローされる例外のトレース</span><span class="sxs-lookup"><span data-stu-id="295c6-129">Tracing Exceptions Thrown in Code</span></span>

<span data-ttu-id="295c6-130">コード内で例外をスローする場合、次のコードを使用して警告以上のレベルでその例外をトレースすることもできます。</span><span class="sxs-lookup"><span data-stu-id="295c6-130">When you throw an exception in code, you can also trace the exception at Warning level or up using the following code.</span></span>

```csharp
ts.TraceEvent(TraceEventType.Warning, 0, "Throwing exception " + "exceptionMessage");
```

## <a name="viewing-user-traces-in-the-service-trace-viewer-tool"></a><span data-ttu-id="295c6-131">サービス トレース ビューアー ツールでのユーザー トレースの表示</span><span class="sxs-lookup"><span data-stu-id="295c6-131">Viewing User Traces in the Service Trace Viewer Tool</span></span>

<span data-ttu-id="295c6-132">このセクションには、[サービストレースビューアーツール (svctraceviewer.exe)](../../service-trace-viewer-tool-svctraceviewer-exe.md)を使用して表示するときに、[拡張トレース](../../samples/extending-tracing.md)サンプルを実行して生成されるトレースのスクリーンショットが含まれています。</span><span class="sxs-lookup"><span data-stu-id="295c6-132">This section contains screenshots of traces generated by running the [Extending Tracing](../../samples/extending-tracing.md) sample, when viewed using the [Service Trace Viewer Tool (SvcTraceViewer.exe)](../../service-trace-viewer-tool-svctraceviewer-exe.md).</span></span>

<span data-ttu-id="295c6-133">次の図では、前に作成した "要求の追加" アクティビティが左側のパネルで選択されています。</span><span class="sxs-lookup"><span data-stu-id="295c6-133">In the following diagram, the "Add request" activity created previously is selected on the left panel.</span></span> <span data-ttu-id="295c6-134">アプリケーション クライアント プログラムを構成する他の 3 つの算術演算アクティビティ (Divide、Subtract、Multiply) も表示されています。</span><span class="sxs-lookup"><span data-stu-id="295c6-134">It is listed with three other Math operation activities (Divide, Subtract, Multiply) that constitute the application client program.</span></span> <span data-ttu-id="295c6-135">どの要求でどのようなエラーが発生したかを明確にするため、ユーザー コードでは、操作ごとに新しいアクティビティが 1 つ定義されています。</span><span class="sxs-lookup"><span data-stu-id="295c6-135">The user code has defined one new activity for each operation to isolate potential error occurrences in different requests.</span></span>

<span data-ttu-id="295c6-136">[トレースの拡張](../../samples/extending-tracing.md)サンプルでの転送の使用方法を示すために、4つの操作要求をカプセル化した電卓アクティビティも作成されます。</span><span class="sxs-lookup"><span data-stu-id="295c6-136">To demonstrate the use of transfers in the [Extending Tracing](../../samples/extending-tracing.md) sample, a Calculator activity that encapsulates the four operation requests is also created.</span></span> <span data-ttu-id="295c6-137">要求があるたびに、Calculator アクティビティから該当する要求のアクティビティへ、または該当する要求のアクティビティから Calculator アクティビティへ移転します (図の右上のパネルにトレースが表示されています)。</span><span class="sxs-lookup"><span data-stu-id="295c6-137">For each request, there is a transfer back and forth from the Calculator activity to the request activity (trace is highlighted in the upper right panel in the figure).</span></span>

<span data-ttu-id="295c6-138">左のパネルでアクティビティを選択すると、そのアクティビティによって追加されたトレースが右上のパネルに表示されます。</span><span class="sxs-lookup"><span data-stu-id="295c6-138">When you select an activity on the left panel, the traces included by this activity are shown on the upper right panel.</span></span> <span data-ttu-id="295c6-139">要求 `propagateActivity` パス内のすべての `true` エンドポイントにがある場合、要求アクティビティのトレースは、要求に参加しているすべてのプロセスからのものです。</span><span class="sxs-lookup"><span data-stu-id="295c6-139">If `propagateActivity` is `true` at every endpoint in the request path, traces in the request activity are from all processes that participate in the request.</span></span> <span data-ttu-id="295c6-140">このサンプルでは、クライアントおよびサービスからのトレースをパネルの 4 番目の列で参照できます。</span><span class="sxs-lookup"><span data-stu-id="295c6-140">In this example, you can see traces from both the client and service in the 4th column in the panel.</span></span>

<span data-ttu-id="295c6-141">このアクティビティは次の順序で処理を行います。</span><span class="sxs-lookup"><span data-stu-id="295c6-141">This activity shows the following order of processing:</span></span>

1. <span data-ttu-id="295c6-142">クライアントはメッセージを Add に送信します。</span><span class="sxs-lookup"><span data-stu-id="295c6-142">Client sends message to Add.</span></span>

2. <span data-ttu-id="295c6-143">サービスは Add 要求メッセージを受信します。</span><span class="sxs-lookup"><span data-stu-id="295c6-143">Service receives Add request message.</span></span>

3. <span data-ttu-id="295c6-144">サービスは Add 応答を送信します。</span><span class="sxs-lookup"><span data-stu-id="295c6-144">Service sends Add response.</span></span>

4. <span data-ttu-id="295c6-145">クライアントは Add 応答を受信します。</span><span class="sxs-lookup"><span data-stu-id="295c6-145">Client receives Add response.</span></span>

<span data-ttu-id="295c6-146">これらすべてのトレースは、Information レベルで出力されています。</span><span class="sxs-lookup"><span data-stu-id="295c6-146">All these traces were emitted at Information level.</span></span> <span data-ttu-id="295c6-147">右上のパネルでトレースをクリックすると、トレースの詳細が右下のパネルに表示されます。</span><span class="sxs-lookup"><span data-stu-id="295c6-147">Clicking a trace in the upper-right panel shows the details of that trace in the lower-right panel.</span></span>

<span data-ttu-id="295c6-148">次の図には、Calculator アクティビティと要求アクティビティ間の転送トレースに加え、1 つの要求アクティビティについて Start トレースと Stop トレースが 2 組表示されています。1 組はクライアントのトレースで、もう 1 組はサーバーのトレースです (各トレース ソースにつき 1 組)。</span><span class="sxs-lookup"><span data-stu-id="295c6-148">In the following diagram, we also see transfer traces from and to the Calculator activity, as well as two pairs of Start and Stop traces per request activity, one for the client and one for the service (one for each trace source).</span></span>

<span data-ttu-id="295c6-149">![トレースビューアー: ユーザー&#45;コードトレースの出力](media/242c9358-475a-4baf-83f3-4227aa942fcd.gif "242c9358-475a-4baf-83f3-4227aa942fcd")作成時刻別のアクティビティの一覧 (左側のパネル) とその入れ子になったアクティビティ (右上のパネル)</span><span class="sxs-lookup"><span data-stu-id="295c6-149">![Trace Viewer: Emitting User&#45;code traces](media/242c9358-475a-4baf-83f3-4227aa942fcd.gif "242c9358-475a-4baf-83f3-4227aa942fcd") List of activities by creation time (left panel) and their nested activities (upper-right panel)</span></span>

<span data-ttu-id="295c6-150">クライアントがスローする原因となる例外を、サービス コードがスローする場合 (たとえば、クライアントが要求に対する応答を取得できなかった場合など)、直接的な相関関係を示すために、サービスとクライアントの両方の警告メッセージまたはエラー メッセージは、同じアクティビティ内に発生します。</span><span class="sxs-lookup"><span data-stu-id="295c6-150">If the service code throws an exception that causes the client to throw as well (for example, when the client did not get the response to its request), both the service and client warning or error messages occur in the same activity for direct correlation.</span></span> <span data-ttu-id="295c6-151">次の図では、サービスは "この要求をユーザーコードで処理できません" という状態を示す例外をスローします。</span><span class="sxs-lookup"><span data-stu-id="295c6-151">In the following image, the service throws an exception that states "The service refuses to process this request in user code."</span></span> <span data-ttu-id="295c6-152">また、クライアントは、"内部エラーのため、サーバーは要求を処理できませんでした。" というメッセージを示す例外をスローします。</span><span class="sxs-lookup"><span data-stu-id="295c6-152">The client also throws an exception that states "The server was unable to process the request due to an internal error."</span></span>

<span data-ttu-id="295c6-153">次の図は、要求アクティビティ id が伝達された場合に、特定の要求のエンドポイント間のエラーが同じアクティビティに表示されることを示しています。</span><span class="sxs-lookup"><span data-stu-id="295c6-153">The following images shows that errors across endpoints for a given request appear in the same activity if the request activity id was propagated:</span></span>

![特定の要求のエンドポイント間のエラーを示すスクリーンショット。](./media/emitting-user-code-traces/trace-viewer-endpoint-errors.gif)

<span data-ttu-id="295c6-155">左パネルの Multiply アクティビティをダブルクリックすると、次のグラフが表示されます。関連するプロセスごとの Multiply アクティビティに対するトレースが示されます。</span><span class="sxs-lookup"><span data-stu-id="295c6-155">Double-clicking the Multiply activity on the left panel shows the following graph, with the traces for the Multiply activity for each process involved.</span></span> <span data-ttu-id="295c6-156">まずサービスで発生した警告 (スローされた例外) が表示され、それに続いて、要求を処理できなかったために発生したクライアントの警告とエラーが表示されます。</span><span class="sxs-lookup"><span data-stu-id="295c6-156">We can see a warning first occurred at the service (exception thrown), which is followed by warnings and errors on the client because the request could not be processed.</span></span> <span data-ttu-id="295c6-157">したがって、エンドポイント間のエラーの因果関係が示され、エラーの根本原因を導き出すことができます。</span><span class="sxs-lookup"><span data-stu-id="295c6-157">Therefore, we can imply the causal error relationship between endpoints and derive the root cause of the error.</span></span>

<span data-ttu-id="295c6-158">次の図は、エラーの相関関係を示すグラフビューを示しています。</span><span class="sxs-lookup"><span data-stu-id="295c6-158">The following image shows a graph view of error correlation:</span></span>

![エラーの相関関係のグラフビューを示すスクリーンショット。](./media/emitting-user-code-traces/trace-viewer-error-correlation.gif)

<span data-ttu-id="295c6-160">以前のトレースを取得するには、ユーザー トレース ソースに対して `ActivityTracing` を設定し、`propagateActivity=true` トレース ソースに対して `System.ServiceModel` を設定します。</span><span class="sxs-lookup"><span data-stu-id="295c6-160">To obtain the previous traces, we set `ActivityTracing` for the user trace sources and `propagateActivity=true` for the `System.ServiceModel` trace source.</span></span> <span data-ttu-id="295c6-161">ユーザー コード間のアクティビティの伝達を有効にするため、`ActivityTracing` トレース ソースの `System.ServiceModel` は設定されていません。</span><span class="sxs-lookup"><span data-stu-id="295c6-161">We did not set `ActivityTracing` for the `System.ServiceModel` trace source to enable user code to user code activity propagation.</span></span> <span data-ttu-id="295c6-162">ServiceModel アクティビティのトレースがオンの場合、クライアントで定義されているアクティビティ ID は、サービスユーザーコードには一切反映されません。ただし、クライアントとサービスのユーザーコードアクティビティを中間 WCF アクティビティに関連付けます。</span><span class="sxs-lookup"><span data-stu-id="295c6-162">(When ServiceModel activity tracing is on, the activity ID defined in the client is not propagated all the way to the service user code; Transfers, however, correlate the client and service user code activities to the intermediate WCF activities.)</span></span>

<span data-ttu-id="295c6-163">アクティビティを定義してアクティビティ ID を伝達することにより、エンドポイント間でエラーの直接相関関係を実行できます。</span><span class="sxs-lookup"><span data-stu-id="295c6-163">Defining activities and propagating the activity ID enables us to perform direct error correlation across endpoints.</span></span> <span data-ttu-id="295c6-164">このようにして、エラーの根本原因をよりすばやく見つけることができるようになります。</span><span class="sxs-lookup"><span data-stu-id="295c6-164">In this way, we can locate the root cause of an error more quickly.</span></span>

## <a name="see-also"></a><span data-ttu-id="295c6-165">関連項目</span><span class="sxs-lookup"><span data-stu-id="295c6-165">See also</span></span>

- [<span data-ttu-id="295c6-166">トレースの拡張</span><span class="sxs-lookup"><span data-stu-id="295c6-166">Extending Tracing</span></span>](../../samples/extending-tracing.md)
