---
title: アプリケーションパフォーマンス管理-WCF 開発者向け gRPC
description: ASP.NET Core gRPC アプリケーションのログ記録、メトリック、トレース。
ms.date: 09/02/2019
ms.openlocfilehash: 98da6c5391f021011e281a57e8f775709fa128ef
ms.sourcegitcommit: 9a97c76e141333394676bc5d264c6624b6f45bcf
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/08/2020
ms.locfileid: "75740974"
---
# <a name="application-performance-management"></a><span data-ttu-id="1edb5-103">アプリケーション パフォーマンス管理</span><span class="sxs-lookup"><span data-stu-id="1edb5-103">Application Performance Management</span></span>

<span data-ttu-id="1edb5-104">Kubernetes のような運用環境では、アプリケーションが最適に実行されるように監視することが重要です。</span><span class="sxs-lookup"><span data-stu-id="1edb5-104">In production environments like Kubernetes, it's important to monitor applications to ensure they're running optimally.</span></span> <span data-ttu-id="1edb5-105">ログ記録とメトリックは特に重要です。</span><span class="sxs-lookup"><span data-stu-id="1edb5-105">Logging and metrics are particularly important.</span></span> <span data-ttu-id="1edb5-106">GRPC を含む ASP.NET Core には、ログメッセージとメトリックデータの生成と管理のための組み込みのサポートと、*トレース*データが用意されています。</span><span class="sxs-lookup"><span data-stu-id="1edb5-106">ASP.NET Core, including gRPC, provides built-in support for producing and managing log messages and metrics data, as well as *tracing* data.</span></span>

## <a name="the-difference-between-logging-and-metrics"></a><span data-ttu-id="1edb5-107">ログ記録とメトリックの違い</span><span class="sxs-lookup"><span data-stu-id="1edb5-107">The difference between logging and metrics</span></span>

<span data-ttu-id="1edb5-108">*ログ記録*は、システムで発生した事柄に関する詳細情報を記録するテキストメッセージに関係しています。</span><span class="sxs-lookup"><span data-stu-id="1edb5-108">*Logging* is concerned with text messages that record detailed information about things that have happened in the system.</span></span> <span data-ttu-id="1edb5-109">ログメッセージには、スタックトレースなどの例外データや、メッセージに関するコンテキストを提供する構造化データが含まれる場合があります。</span><span class="sxs-lookup"><span data-stu-id="1edb5-109">Log messages might include exception data, like stack traces, or structured data that provides context about the message.</span></span> <span data-ttu-id="1edb5-110">ログ出力は、通常、検索可能なテキストストアに書き込まれます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-110">Logging output is commonly written to a searchable text store.</span></span>

<span data-ttu-id="1edb5-111">*メトリック*は、ダッシュボードでグラフやグラフを使用して集計および表示するように設計された数値データを指します。</span><span class="sxs-lookup"><span data-stu-id="1edb5-111">*Metrics* refers to numeric data designed to be aggregated and presented by using charts and graphs in a dashboard.</span></span> <span data-ttu-id="1edb5-112">ダッシュボードには、アプリケーションの全体的な正常性とパフォーマンスが表示されます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-112">The dashboard provides a view of the overall health and performance of an application.</span></span> <span data-ttu-id="1edb5-113">メトリックデータを使用して、しきい値を超えたときに自動アラートをトリガーすることもできます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-113">Metrics data can also be used to trigger automated alerts when a threshold is exceeded.</span></span> <span data-ttu-id="1edb5-114">メトリックデータの例をいくつか次に示します。</span><span class="sxs-lookup"><span data-stu-id="1edb5-114">Here are some examples of metrics data:</span></span>

- <span data-ttu-id="1edb5-115">要求の処理にかかった時間。</span><span class="sxs-lookup"><span data-stu-id="1edb5-115">Time taken to process requests.</span></span>
- <span data-ttu-id="1edb5-116">サービスのインスタンスによって処理される1秒あたりの要求の数。</span><span class="sxs-lookup"><span data-stu-id="1edb5-116">The number of requests per second being handled by an instance of a service.</span></span>
- <span data-ttu-id="1edb5-117">インスタンスで失敗した要求の数。</span><span class="sxs-lookup"><span data-stu-id="1edb5-117">The number of failed requests on an instance.</span></span>

## <a name="logging-in-aspnet-core-grpc"></a><span data-ttu-id="1edb5-118">GRPC ASP.NET Core のログイン</span><span class="sxs-lookup"><span data-stu-id="1edb5-118">Logging in ASP.NET Core gRPC</span></span>

<span data-ttu-id="1edb5-119">ASP.NET Core には、ログ記録の組み込みサポートが用意されて[います。](https://www.nuget.org/packages/Microsoft.Extensions.Logging)</span><span class="sxs-lookup"><span data-stu-id="1edb5-119">ASP.NET Core provides built-in support for logging, in the form of the [Microsoft.Extensions.Logging](https://www.nuget.org/packages/Microsoft.Extensions.Logging) NuGet package.</span></span> <span data-ttu-id="1edb5-120">このライブラリのコア部分は Web SDK に含まれているため、手動でインストールする必要はありません。</span><span class="sxs-lookup"><span data-stu-id="1edb5-120">The core parts of this library are included with the Web SDK, so there's no need to install it manually.</span></span> <span data-ttu-id="1edb5-121">既定では、ログメッセージは、標準出力 ("コンソール") と、アタッチされている任意のデバッガーに書き込まれます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-121">By default, log messages are written to the standard output (the "console") and to any attached debugger.</span></span> <span data-ttu-id="1edb5-122">永続的な外部データストアにログを書き込むには、オプションの[ログシンクパッケージ](https://docs.microsoft.com/aspnet/core/fundamentals/logging/?view=aspnetcore-3.0#third-party-logging-providers)のインポートが必要になることがあります。</span><span class="sxs-lookup"><span data-stu-id="1edb5-122">To write logs to persistent external data stores, you might need to import [optional logging sink packages](https://docs.microsoft.com/aspnet/core/fundamentals/logging/?view=aspnetcore-3.0#third-party-logging-providers).</span></span>

<span data-ttu-id="1edb5-123">ASP.NET Core gRPC フレームワークは、詳細な診断ログメッセージをこのログ記録フレームワークに書き込みます。これにより、アプリケーション独自のメッセージと共に処理および格納することができます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-123">The ASP.NET Core gRPC framework writes detailed diagnostic logging messages to this logging framework, so they can be processed and stored along with your application's own messages.</span></span>

### <a name="produce-log-messages"></a><span data-ttu-id="1edb5-124">ログメッセージの生成</span><span class="sxs-lookup"><span data-stu-id="1edb5-124">Produce log messages</span></span>

<span data-ttu-id="1edb5-125">ログの拡張機能は ASP.NET Core の依存関係の注入システムに自動的に登録されるため、gRPC サービスの種類で logger をコンストラクターパラメーターとして指定できます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-125">The logging extension is automatically registered with ASP.NET Core's dependency injection system, so you can specify loggers as a constructor parameter on gRPC service types.</span></span>

```csharp
public class StockData : Stocks.StocksBase
{
    private readonly ILogger<StockData> _logger;

    public StockData(ILogger<StockData> logger)
    {
        _logger = logger;
    }
}
```

<span data-ttu-id="1edb5-126">要求や例外などの多くのログメッセージは、ASP.NET Core および gRPC フレームワークコンポーネントによって提供されます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-126">Many log messages, such as requests and exceptions, are provided by the ASP.NET Core and gRPC framework components.</span></span> <span data-ttu-id="1edb5-127">独自のログメッセージを追加して、下位レベルの問題ではなく、アプリケーションロジックに関する詳細とコンテキストを提供します。</span><span class="sxs-lookup"><span data-stu-id="1edb5-127">Add your own log messages to provide detail and context about application logic, rather than lower-level concerns.</span></span>

<span data-ttu-id="1edb5-128">ログメッセージと使用可能なログシンクおよびターゲットの記述の詳細については、「 [.Net Core でのログ記録」および「ASP.NET Core](/aspnet/core/fundamentals/logging/)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="1edb5-128">For more information about writing log messages and available logging sinks and targets, see  [Logging in .NET Core and ASP.NET Core](/aspnet/core/fundamentals/logging/).</span></span>

## <a name="metrics-in-aspnet-core-grpc"></a><span data-ttu-id="1edb5-129">ASP.NET Core gRPC のメトリック</span><span class="sxs-lookup"><span data-stu-id="1edb5-129">Metrics in ASP.NET Core gRPC</span></span>

<span data-ttu-id="1edb5-130">.NET Core ランタイムには、メトリックを生成および監視するための一連のコンポーネントが用意されています。</span><span class="sxs-lookup"><span data-stu-id="1edb5-130">The .NET Core runtime provides a set of components for emitting and observing metrics.</span></span> <span data-ttu-id="1edb5-131">これには、<xref:System.Diagnostics.Tracing.EventSource> や <xref:System.Diagnostics.Tracing.EventCounter> クラスなどの Api が含まれます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-131">These include APIs such as the <xref:System.Diagnostics.Tracing.EventSource> and <xref:System.Diagnostics.Tracing.EventCounter> classes.</span></span> <span data-ttu-id="1edb5-132">これらの Api は、 [dotnet グローバルツール](../../core/diagnostics/dotnet-counters.md)や Windows イベントトレーシングなど、外部プロセスで使用できる基本的な数値データを生成できます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-132">These APIs can emit basic numeric data that can be consumed by external processes, like the [dotnet-counters global tool](../../core/diagnostics/dotnet-counters.md), or Event Tracing for Windows.</span></span> <span data-ttu-id="1edb5-133">独自のコードで `EventCounter` を使用する方法の詳細については、「 [Eventcounter の概要](https://github.com/dotnet/runtime/blob/master/src/libraries/System.Diagnostics.Tracing/documentation/EventCounterTutorial.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="1edb5-133">For more information about using `EventCounter` in your own code, see [EventCounter introduction](https://github.com/dotnet/runtime/blob/master/src/libraries/System.Diagnostics.Tracing/documentation/EventCounterTutorial.md).</span></span>

<span data-ttu-id="1edb5-134">より高度なメトリックのほか、広範なデータストアにメトリックデータを書き込む場合は、[アプリメトリック](https://www.app-metrics.io)と呼ばれるオープンソースプロジェクトを試すことができます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-134">For more advanced metrics and for writing metric data to a wider range of data stores, you might try an open-source project called [App Metrics](https://www.app-metrics.io).</span></span> <span data-ttu-id="1edb5-135">この一連のライブラリには、コードをインストルメント化するための広範な種類のセットが用意されています。</span><span class="sxs-lookup"><span data-stu-id="1edb5-135">This suite of libraries provides an extensive set of types to instrument your code.</span></span> <span data-ttu-id="1edb5-136">また、Prometheus、InfluxDB、 [Application Insights](https://docs.microsoft.com/azure/azure-monitor/app/app-insights-overview)などの時系列データベースを含むさまざまな種類のターゲットにメトリックを書き込むパッケージも提供します。</span><span class="sxs-lookup"><span data-stu-id="1edb5-136">It also offers packages to write metrics to different kinds of targets that include time-series databases, such as Prometheus and InfluxDB, and [Application Insights](https://docs.microsoft.com/azure/azure-monitor/app/app-insights-overview).</span></span> <span data-ttu-id="1edb5-137">[AspNetCore](https://www.nuget.org/packages/App.Metrics.AspNetCore.Mvc/) NuGet パッケージでは、ASP.NET Core framework との統合によって自動的に生成される、基本的なメトリックの包括的なセットも追加されます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-137">The [App.Metrics.AspNetCore.Mvc](https://www.nuget.org/packages/App.Metrics.AspNetCore.Mvc/) NuGet package even adds a comprehensive set of basic metrics that are automatically generated via integration with the ASP.NET Core framework.</span></span> <span data-ttu-id="1edb5-138">プロジェクトの web サイトには、 [Grafana](https://grafana.com/) visualization platform でこれらのメトリックを表示するための[テンプレート](https://www.app-metrics.io/samples/grafana/)が用意されています。</span><span class="sxs-lookup"><span data-stu-id="1edb5-138">The project website provides [templates](https://www.app-metrics.io/samples/grafana/) for displaying those metrics with the [Grafana](https://grafana.com/) visualization platform.</span></span>

### <a name="produce-metrics"></a><span data-ttu-id="1edb5-139">メトリックを生成する</span><span class="sxs-lookup"><span data-stu-id="1edb5-139">Produce metrics</span></span>

<span data-ttu-id="1edb5-140">ほとんどのメトリックプラットフォームでは、次の種類がサポートされています。</span><span class="sxs-lookup"><span data-stu-id="1edb5-140">Most metrics platforms support the following types:</span></span>

| <span data-ttu-id="1edb5-141">メトリックの種類</span><span class="sxs-lookup"><span data-stu-id="1edb5-141">Metric type</span></span> | <span data-ttu-id="1edb5-142">説明</span><span class="sxs-lookup"><span data-stu-id="1edb5-142">Description</span></span> |
| ----------- | ----------- |
| <span data-ttu-id="1edb5-143">カウンター</span><span class="sxs-lookup"><span data-stu-id="1edb5-143">Counter</span></span>     | <span data-ttu-id="1edb5-144">要求やエラーなど、何かが発生する頻度を追跡します。</span><span class="sxs-lookup"><span data-stu-id="1edb5-144">Tracks how often something happens, such as requests and errors.</span></span> |
| <span data-ttu-id="1edb5-145">ゲージ</span><span class="sxs-lookup"><span data-stu-id="1edb5-145">Gauge</span></span>       | <span data-ttu-id="1edb5-146">アクティブな接続など、時間の経過と共に変化する1つの値を記録します。</span><span class="sxs-lookup"><span data-stu-id="1edb5-146">Records a single value that changes over time, such as active connections.</span></span> |
| <span data-ttu-id="1edb5-147">ヒストグラム</span><span class="sxs-lookup"><span data-stu-id="1edb5-147">Histogram</span></span>   | <span data-ttu-id="1edb5-148">任意の制限で値の分布を測定します。</span><span class="sxs-lookup"><span data-stu-id="1edb5-148">Measures a distribution of values across arbitrary limits.</span></span> <span data-ttu-id="1edb5-149">たとえば、ヒストグラムは、データセットのサイズを追跡し、含まれている < 10 レコード11-100、含まれているレコードの数、101-1000 レコードの数、および > 1000 レコードが含まれている数をカウントできます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-149">For example, a histogram can track dataset size, counting how many contained <10 records, how many contained 11-100 records, how many contained 101-1000 records, and how many contained >1000 records.</span></span> |
| <span data-ttu-id="1edb5-150">メータリング</span><span class="sxs-lookup"><span data-stu-id="1edb5-150">Meter</span></span>       | <span data-ttu-id="1edb5-151">さまざまな期間におけるイベントの発生率を測定します。</span><span class="sxs-lookup"><span data-stu-id="1edb5-151">Measures the rate at which an event occurs in various time spans.</span></span> |
| <span data-ttu-id="1edb5-152">タイマ</span><span class="sxs-lookup"><span data-stu-id="1edb5-152">Timer</span></span>       | <span data-ttu-id="1edb5-153">イベントの期間とその発生率を追跡し、ヒストグラムとして格納します。</span><span class="sxs-lookup"><span data-stu-id="1edb5-153">Tracks the duration of events and the rate at which it occurs, stored as a histogram.</span></span> |

<span data-ttu-id="1edb5-154">*アプリメトリック*を使用すると、依存関係の注入によって `IMetrics` インターフェイスを取得し、grpc サービスのこれらのメトリックを記録するために使用できます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-154">By using *App Metrics*, an `IMetrics` interface can be obtained via dependency injection, and used to record any of these metrics for a gRPC service.</span></span> <span data-ttu-id="1edb5-155">次の例では、時間の経過と共に行われた `Get` 要求の数をカウントする方法を示します。</span><span class="sxs-lookup"><span data-stu-id="1edb5-155">The following example shows how to count the number of `Get` requests made over time:</span></span>

```csharp
public class StockData : Stocks.StocksBase
{
    private static readonly CounterOptions GetRequestCounter = new CounterOptions
    {
        Name = "StockData_Get_Requests",
        MeasurementUnit = Unit.Calls
    };

    private readonly IStockRepository _repository;
    private readonly IMetrics _metrics;

    public StockData(IStockRepository repository, IMetrics metrics)
    {
        _repository = repository;
        _metrics = metrics;
    }

    public override async Task<GetResponse> Get(GetRequest request, ServerCallContext context)
    {
        _metrics.Measure.Counter.Increment(GetRequestCounter);

        // Serve request...
    }
}
```

### <a name="store-and-visualize-metrics-data"></a><span data-ttu-id="1edb5-156">メトリックデータの格納と視覚化</span><span class="sxs-lookup"><span data-stu-id="1edb5-156">Store and visualize metrics data</span></span>

<span data-ttu-id="1edb5-157">メトリックデータを格納する最善の方法は、*タイムシリーズデータベース*で、タイムスタンプでマークされた数値データ系列を記録するように設計された特殊なデータストアです。</span><span class="sxs-lookup"><span data-stu-id="1edb5-157">The best way to store metrics data is in a *time-series database*, a specialized data store designed to record numerical data series marked with timestamps.</span></span> <span data-ttu-id="1edb5-158">これらのデータベースのうち最も一般的なものは、 [Prometheus](https://prometheus.io/)と[InfluxDB](https://www.influxdata.com/products/influxdb-overview/)です。</span><span class="sxs-lookup"><span data-stu-id="1edb5-158">The most popular of these databases are [Prometheus](https://prometheus.io/) and [InfluxDB](https://www.influxdata.com/products/influxdb-overview/).</span></span> <span data-ttu-id="1edb5-159">また Microsoft Azure は、 [Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/overview)サービスを介した専用のメトリックストレージも提供します。</span><span class="sxs-lookup"><span data-stu-id="1edb5-159">Microsoft Azure also provides dedicated metrics storage through the [Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/overview) service.</span></span>

<span data-ttu-id="1edb5-160">メトリックデータを視覚化するための最新のソリューションは[Grafana](https://grafana.com)であり、幅広いストレージプロバイダーで動作します。</span><span class="sxs-lookup"><span data-stu-id="1edb5-160">The current go-to solution for visualizing metrics data is [Grafana](https://grafana.com), which works with a wide range of storage providers.</span></span> <span data-ttu-id="1edb5-161">次の図は、StockData サンプルを実行している Linkerd service メッシュのメトリックを表示する Grafana ダッシュボードの例を示しています。</span><span class="sxs-lookup"><span data-stu-id="1edb5-161">The following image shows an example Grafana dashboard that displays metrics from the Linkerd service mesh running the StockData sample:</span></span>

![Grafana ダッシュボードのスクリーンショット](media/application-performance-management/grafana-screenshot.png)

### <a name="metrics-based-alerting"></a><span data-ttu-id="1edb5-163">メトリックベースのアラート</span><span class="sxs-lookup"><span data-stu-id="1edb5-163">Metrics-based alerting</span></span>

<span data-ttu-id="1edb5-164">メトリックデータの数値の性質は、警告システムを駆動し、定義された許容範囲外に値がある場合に開発者やサポートエンジニアに通知することが理想的であることを意味します。</span><span class="sxs-lookup"><span data-stu-id="1edb5-164">The numerical nature of metrics data means that it's ideally suited to drive alerting systems, notifying developers or support engineers when a value falls outside of some defined tolerance.</span></span> <span data-ttu-id="1edb5-165">既に説明したプラットフォームでは、電子メール、テキストメッセージ、ダッシュボード内視覚エフェクトなど、さまざまなオプションを使用したアラートのサポートが提供されています。</span><span class="sxs-lookup"><span data-stu-id="1edb5-165">The platforms already mentioned all provide support for alerting via a range of options, including emails, text messages, or in-dashboard visualizations.</span></span>

## <a name="distributed-tracing"></a><span data-ttu-id="1edb5-166">分散トレース</span><span class="sxs-lookup"><span data-stu-id="1edb5-166">Distributed tracing</span></span>

<span data-ttu-id="1edb5-167">分散トレースは、監視の比較的最近の開発で、マイクロサービスと分散アーキテクチャの使用量が増加してきました。</span><span class="sxs-lookup"><span data-stu-id="1edb5-167">Distributed tracing is a relatively recent development in monitoring, which has arisen from the increasing use of microservices and distributed architectures.</span></span> <span data-ttu-id="1edb5-168">クライアントのブラウザー、アプリケーション、またはデバイスからの単一の要求は、多くの手順とサブ要求に分割でき、ネットワーク全体で多くのサービスを使用します。</span><span class="sxs-lookup"><span data-stu-id="1edb5-168">A single request from a client browser, application, or device can be broken down into many steps and sub-requests, and involve the use of many services across a network.</span></span> <span data-ttu-id="1edb5-169">これにより、ログメッセージとメトリックを、トリガーされた特定の要求と関連付けるのが困難になります。</span><span class="sxs-lookup"><span data-stu-id="1edb5-169">This makes it difficult to correlate log messages and metrics with the specific request that triggered them.</span></span> <span data-ttu-id="1edb5-170">分散トレースは、要求に識別子を適用します。これにより、ログとメトリックを特定の操作に関連付けることができます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-170">Distributed tracing applies identifiers to requests, and this allows logs and metrics to be correlated with a particular operation.</span></span> <span data-ttu-id="1edb5-171">これは、 [WCF のエンドツーエンドのトレース](../../framework/wcf/diagnostics/tracing/end-to-end-tracing.md)に似ていますが、複数のプラットフォームに適用されます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-171">This is similar to [WCF's end-to-end tracing](../../framework/wcf/diagnostics/tracing/end-to-end-tracing.md), but it's applied across multiple platforms.</span></span>

<span data-ttu-id="1edb5-172">分散トレースは急速に成長しており、標準化が開始されています。</span><span class="sxs-lookup"><span data-stu-id="1edb5-172">Distributed tracing has grown quickly in popularity and is beginning to standardize.</span></span> <span data-ttu-id="1edb5-173">Cloud Native Computing Foundation は、[オープントレース標準](https://opentracing.io)を作成しました。これは、 [Jaeger](https://www.jaegertracing.io/)や[エラスティック APM](https://www.elastic.co/products/apm)などのバックエンドを操作するために、ベンダー中立のライブラリを提供しようとしています。</span><span class="sxs-lookup"><span data-stu-id="1edb5-173">The Cloud Native Computing Foundation created the [the Open Tracing standard](https://opentracing.io), attempting to provide vendor-neutral libraries for working with back ends like [Jaeger](https://www.jaegertracing.io/) and [Elastic APM](https://www.elastic.co/products/apm).</span></span> <span data-ttu-id="1edb5-174">同時に、Google は同じ問題のセットを解決するために[OpenCensus プロジェクト](https://opencensus.io/)を作成しました。</span><span class="sxs-lookup"><span data-stu-id="1edb5-174">At the same time, Google created the [OpenCensus project](https://opencensus.io/) to address the same set of problems.</span></span> <span data-ttu-id="1edb5-175">これら2つのプロジェクトは、新しいプロジェクトである[OpenTelemetry](https://opentelemetry.io)にマージされます。これは、将来の業界標準です。</span><span class="sxs-lookup"><span data-stu-id="1edb5-175">These two projects are merging into a new project, [OpenTelemetry](https://opentelemetry.io), which aims to be the industry standard of the future.</span></span>

### <a name="how-distributed-tracing-works"></a><span data-ttu-id="1edb5-176">分散トレースのしくみ</span><span class="sxs-lookup"><span data-stu-id="1edb5-176">How distributed tracing works</span></span>

<span data-ttu-id="1edb5-177">分散トレースは、*範囲*の概念に基づいています。これは、1つの*トレース*の一部である名前付きの時間指定操作で、システムの複数のノードでの処理が必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="1edb5-177">Distributed tracing is based on the concept of *spans*: named, timed operations that are part of a single *trace*, which can involve processing on multiple nodes of a system.</span></span> <span data-ttu-id="1edb5-178">新しい操作が開始されると、一意の識別子を使用してトレースが作成されます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-178">When a new operation is initiated, a trace is created with a unique identifier.</span></span> <span data-ttu-id="1edb5-179">各サブ操作に対して、スパンは独自の識別子とトレース識別子を使用して作成されます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-179">For each sub-operation, a span is created with its own identifier and trace identifier.</span></span> <span data-ttu-id="1edb5-180">要求がシステムを通過すると、さまざまなコンポーネントが*親*の識別子を含む*子*スパンを作成できます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-180">As the request passes around the system, various components can create *child* spans that include the identifier of their *parent*.</span></span> <span data-ttu-id="1edb5-181">スパンには、トレース識別子とスパン識別子を含む*コンテキスト*と、キーと値のペア (*荷物*と呼ばれます) の形式の有用なデータが含まれています。</span><span class="sxs-lookup"><span data-stu-id="1edb5-181">A span has a *context*, which contains the trace and span identifiers, as well as useful data in the form of key and value pairs (called *baggage*).</span></span>

### <a name="distributed-tracing-with-diagnosticsource"></a><span data-ttu-id="1edb5-182">`DiagnosticSource` を使用した分散トレース</span><span class="sxs-lookup"><span data-stu-id="1edb5-182">Distributed tracing with `DiagnosticSource`</span></span>

<span data-ttu-id="1edb5-183">.NET Core には、分散トレースおよびスパン ( [DiagnosticSource](https://github.com/dotnet/runtime/blob/master/src/libraries/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md#diagnosticsource-users-guide)) に適切にマップされる内部モジュールがあります。</span><span class="sxs-lookup"><span data-stu-id="1edb5-183">.NET Core has an internal module that maps well to distributed traces and spans: [DiagnosticSource](https://github.com/dotnet/runtime/blob/master/src/libraries/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md#diagnosticsource-users-guide).</span></span> <span data-ttu-id="1edb5-184">また、プロセス内で診断を生成して使用する簡単な方法が用意されているだけでなく、`DiagnosticSource` モジュールには*アクティビティ*の概念があります。</span><span class="sxs-lookup"><span data-stu-id="1edb5-184">As well as providing a simple way to produce and consume diagnostics within a process, the `DiagnosticSource` module has the concept of an *activity*.</span></span> <span data-ttu-id="1edb5-185">アクティビティは、実質的には、分散トレースまたはトレース内のスパンの実装です。</span><span class="sxs-lookup"><span data-stu-id="1edb5-185">An activity is effectively an implementation of a distributed trace, or a span within a trace.</span></span> <span data-ttu-id="1edb5-186">モジュールの内部では、識別子の割り当てなど、親/子アクティビティが処理されます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-186">The internals of the module take care of parent/child activities, including allocating identifiers.</span></span> <span data-ttu-id="1edb5-187">`Activity` の種類の使用方法の詳細については、 [GitHub のアクティビティユーザーガイド](https://github.com/dotnet/runtime/blob/master/src/libraries/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#activity-user-guide)を参照してください。</span><span class="sxs-lookup"><span data-stu-id="1edb5-187">For more information about using the `Activity` type, see the [Activity User Guide on GitHub](https://github.com/dotnet/runtime/blob/master/src/libraries/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#activity-user-guide).</span></span>

<span data-ttu-id="1edb5-188">`DiagnosticSource` はコアフレームワークの一部であるため、いくつかのコアコンポーネントでサポートされています。</span><span class="sxs-lookup"><span data-stu-id="1edb5-188">Because `DiagnosticSource` is a part of the core framework, it's supported by several core components.</span></span> <span data-ttu-id="1edb5-189">これには、gRPC フレームワークでの明示的なサポートを含む、<xref:System.Net.Http.HttpClient>、Entity Framework Core、ASP.NET Core が含まれます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-189">These include <xref:System.Net.Http.HttpClient>, Entity Framework Core, and ASP.NET Core, including explicit support in the gRPC framework.</span></span> <span data-ttu-id="1edb5-190">ASP.NET Core が要求を受信すると、 [W3C トレースコンテキスト](https://www.w3.org/TR/trace-context)標準に一致する HTTP ヘッダーのペアが確認されます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-190">When ASP.NET Core receives a request, it checks for a pair of HTTP headers matching the [W3C Trace Context](https://www.w3.org/TR/trace-context) standard.</span></span> <span data-ttu-id="1edb5-191">ヘッダーが見つかった場合は、ヘッダーの id 値とコンテキストを使用してアクティビティが開始されます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-191">If the headers are found, an activity is started by using the identity values and context from the headers.</span></span> <span data-ttu-id="1edb5-192">ヘッダーが見つからない場合は、標準形式に一致する生成された id 値を使用してアクティビティが開始されます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-192">If no headers are found, an activity is started with generated identity values that match the standard format.</span></span> <span data-ttu-id="1edb5-193">このアクティビティの有効期間中に、フレームワークまたはアプリケーションコードによって生成される診断には、トレース id とスパン識別子をタグ付けできます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-193">Any diagnostics generated by the framework or by application code during the lifetime of this activity can be tagged with the trace and span identifiers.</span></span> <span data-ttu-id="1edb5-194">`HttpClient` サポートは、すべての要求の現在のアクティビティを確認し、トレースヘッダーを送信要求に自動的に追加することで、これをさらに拡張します。</span><span class="sxs-lookup"><span data-stu-id="1edb5-194">The `HttpClient` support extends this further by checking for a current activity on every request, and automatically adding the trace headers to the outgoing request.</span></span>

<span data-ttu-id="1edb5-195">ASP.NET Core gRPC クライアントおよびサーバーライブラリには、`DiagnosticSource` と `Activity`の明示的なサポートが含まれています。また、アクティビティを作成し、ヘッダー情報を自動的に適用して使用します。</span><span class="sxs-lookup"><span data-stu-id="1edb5-195">The ASP.NET Core gRPC client and server libraries include explicit support for `DiagnosticSource` and `Activity`, and create activities and apply and use header information automatically.</span></span>

> [!NOTE]
> <span data-ttu-id="1edb5-196">これは、リスナーが診断情報を消費している場合にのみ発生します。</span><span class="sxs-lookup"><span data-stu-id="1edb5-196">All of this happens only if a listener is consuming the diagnostic information.</span></span> <span data-ttu-id="1edb5-197">リスナーが存在しない場合、診断は書き込まれず、アクティビティも作成されません。</span><span class="sxs-lookup"><span data-stu-id="1edb5-197">If there's no listener, no diagnostics are written and no activities are created.</span></span>

### <a name="add-your-own-diagnosticsource-and-activity"></a><span data-ttu-id="1edb5-198">独自の `DiagnosticSource` と `Activity` を追加する</span><span class="sxs-lookup"><span data-stu-id="1edb5-198">Add your own `DiagnosticSource` and `Activity`</span></span>

<span data-ttu-id="1edb5-199">独自の診断を追加したり、アプリケーションコード内に明示的な範囲を作成したりするには、『 [DiagnosticSource User guide](https://github.com/dotnet/runtime/blob/master/src/libraries/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md#instrumenting-with-diagnosticsourcediagnosticlistener) And [Activity user guide 』](https://github.com/dotnet/runtime/blob/master/src/libraries/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#activity-usage)を参照してください。</span><span class="sxs-lookup"><span data-stu-id="1edb5-199">To add your own diagnostics or create explicit spans within your application code, see the [DiagnosticSource User Guide](https://github.com/dotnet/runtime/blob/master/src/libraries/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md#instrumenting-with-diagnosticsourcediagnosticlistener) and [Activity User Guide](https://github.com/dotnet/runtime/blob/master/src/libraries/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#activity-usage).</span></span>

### <a name="store-distributed-trace-data"></a><span data-ttu-id="1edb5-200">分散トレースデータを格納する</span><span class="sxs-lookup"><span data-stu-id="1edb5-200">Store distributed trace data</span></span>

<span data-ttu-id="1edb5-201">このドキュメントの執筆時点では、OpenTelemetry プロジェクトは依然として初期段階にあり、.NET アプリケーションではアルファ品質のパッケージのみを使用できます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-201">At the time of writing, the OpenTelemetry project is still in the early stages, and only alpha-quality packages are available for .NET applications.</span></span> <span data-ttu-id="1edb5-202">OpenTracing プロジェクトには、現在、より成熟したライブラリが用意されています。</span><span class="sxs-lookup"><span data-stu-id="1edb5-202">The OpenTracing project currently offers more mature libraries.</span></span>

<span data-ttu-id="1edb5-203">OpenTracing API については、次のセクションで説明します。</span><span class="sxs-lookup"><span data-stu-id="1edb5-203">The OpenTracing API is described in the following section.</span></span> <span data-ttu-id="1edb5-204">代わりに、アプリケーションで OpenTelemetry API を使用する場合は、GitHub の[OpenTelemetry .NET SDK リポジトリ](https://github.com/open-telemetry/opentelemetry-dotnet)を参照してください。</span><span class="sxs-lookup"><span data-stu-id="1edb5-204">If you want to use the OpenTelemetry API in your application instead, refer to the [OpenTelemetry .NET SDK repository](https://github.com/open-telemetry/opentelemetry-dotnet) on GitHub.</span></span>

#### <a name="use-the-opentracing-package-to-store-distributed-trace-data"></a><span data-ttu-id="1edb5-205">OpenTracing パッケージを使用して分散トレースデータを格納する</span><span class="sxs-lookup"><span data-stu-id="1edb5-205">Use the OpenTracing package to store distributed trace data</span></span>

<span data-ttu-id="1edb5-206">[Opentracing NuGet パッケージ](https://www.nuget.org/packages/OpenTracing/)は、opentracing に準拠しているすべてのバックエンド (`DiagnosticSource`とは無関係に使用できます) をサポートしています。</span><span class="sxs-lookup"><span data-stu-id="1edb5-206">The [OpenTracing NuGet package](https://www.nuget.org/packages/OpenTracing/) supports all OpenTracing-compliant back ends (which can be used independently of `DiagnosticSource`).</span></span> <span data-ttu-id="1edb5-207">OpenTracing API の投稿プロジェクト ( [Opentracing](https://www.nuget.org/packages/OpenTracing.Contrib.NetCore/)) には、追加のパッケージがあります。</span><span class="sxs-lookup"><span data-stu-id="1edb5-207">There's an additional package from the OpenTracing API Contributions project, [OpenTracing.Contrib.NetCore](https://www.nuget.org/packages/OpenTracing.Contrib.NetCore/).</span></span> <span data-ttu-id="1edb5-208">このパッケージは、`DiagnosticSource` リスナーを追加し、イベントとアクティビティをバックエンドに自動的に書き込みます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-208">This package adds a `DiagnosticSource` listener, and writes events and activities to a back end automatically.</span></span> <span data-ttu-id="1edb5-209">このパッケージを有効にすることは、NuGet からインストールし、`Startup` クラスでサービスとして追加するのと同じように簡単です。</span><span class="sxs-lookup"><span data-stu-id="1edb5-209">Enabling this package is as simple as installing it from NuGet and adding it as a service in your `Startup` class.</span></span>

```csharp
public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services.AddOpenTracing();
    }
}
```

<span data-ttu-id="1edb5-210">OpenTracing パッケージは抽象レイヤーであるため、バックエンドに固有の実装が必要です。</span><span class="sxs-lookup"><span data-stu-id="1edb5-210">The OpenTracing package is an abstraction layer, and as such it requires implementation specific to the back end.</span></span> <span data-ttu-id="1edb5-211">OpenTracing API の実装は、次のオープンソースバックエンドで使用できます。</span><span class="sxs-lookup"><span data-stu-id="1edb5-211">OpenTracing API implementations are available for the following open source back ends.</span></span>

| <span data-ttu-id="1edb5-212">[名前]</span><span class="sxs-lookup"><span data-stu-id="1edb5-212">Name</span></span> | <span data-ttu-id="1edb5-213">[パッケージ]</span><span class="sxs-lookup"><span data-stu-id="1edb5-213">Package</span></span> | <span data-ttu-id="1edb5-214">Web サイト</span><span class="sxs-lookup"><span data-stu-id="1edb5-214">Website</span></span> |
| ---- | ------- | -------- |
| <span data-ttu-id="1edb5-215">Jaeger</span><span class="sxs-lookup"><span data-stu-id="1edb5-215">Jaeger</span></span> | [<span data-ttu-id="1edb5-216">Jaeger</span><span class="sxs-lookup"><span data-stu-id="1edb5-216">Jaeger</span></span>](https://www.nuget.org/packages/Jaeger/) | [<span data-ttu-id="1edb5-217">jaegertracing.io</span><span class="sxs-lookup"><span data-stu-id="1edb5-217">jaegertracing.io</span></span>](https://jaegertracing.io) |
| <span data-ttu-id="1edb5-218">エラスティック APM</span><span class="sxs-lookup"><span data-stu-id="1edb5-218">Elastic APM</span></span> | [<span data-ttu-id="1edb5-219">エラスティック. NetCoreAll</span><span class="sxs-lookup"><span data-stu-id="1edb5-219">Elastic.Apm.NetCoreAll</span></span>](https://www.nuget.org/packages/Elastic.Apm.NetCoreAll/) | [<span data-ttu-id="1edb5-220">elastic.co/products/apm</span><span class="sxs-lookup"><span data-stu-id="1edb5-220">elastic.co/products/apm</span></span>](https://www.elastic.co/products/apm) |

<span data-ttu-id="1edb5-221">.Net 用 opentracing API の詳細については、GitHub の opentracing [for C# ](https://github.com/opentracing/opentracing-csharp)と[opentracing Contrib C#/.NET Core](https://github.com/opentracing-contrib/csharp-netcore)リポジトリを参照してください。</span><span class="sxs-lookup"><span data-stu-id="1edb5-221">For more information on the OpenTracing API for .NET, see the [OpenTracing for C#](https://github.com/opentracing/opentracing-csharp) and the [OpenTracing Contrib C#/.NET Core](https://github.com/opentracing-contrib/csharp-netcore) repositories on GitHub.</span></span>

>[!div class="step-by-step"]
><span data-ttu-id="1edb5-222">[前へ](load-balancing.md)
>[次へ](appendix.md)</span><span class="sxs-lookup"><span data-stu-id="1edb5-222">[Previous](load-balancing.md)
[Next](appendix.md)</span></span>
