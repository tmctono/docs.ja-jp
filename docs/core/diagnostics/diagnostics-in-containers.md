---
title: コンテナーでの診断の収集
description: この記事では、.NET Core 診断ツールを Docker コンテナーで使用する方法について説明します。
ms.date: 09/01/2020
ms.openlocfilehash: e57f3696433bbf6f35b2e3e5d1e72ae8b1e3eeb3
ms.sourcegitcommit: b4a46f6d7ebf44c0035627d00924164bcae2db30
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/29/2020
ms.locfileid: "91450835"
---
# <a name="collect-diagnostics-in-containers"></a><span data-ttu-id="d540f-103">コンテナーでの診断の収集</span><span class="sxs-lookup"><span data-stu-id="d540f-103">Collect diagnostics in containers</span></span>

<span data-ttu-id="d540f-104">他のシナリオでの .NET Core の問題の診断に役立つ同じ診断ツールが、Docker コンテナーでも動作します。</span><span class="sxs-lookup"><span data-stu-id="d540f-104">The same diagnostics tools that are useful for diagnosing .NET Core issues in other scenarios also work in Docker containers.</span></span> <span data-ttu-id="d540f-105">ただし、一部のツールについては、コンテナーで使用するには特別な手順が必要になります。</span><span class="sxs-lookup"><span data-stu-id="d540f-105">However, some of the tools require special steps to work in a container.</span></span> <span data-ttu-id="d540f-106">この記事では、パフォーマンス トレースとダンプを収集するためのツールを、Docker コンテナーで使用する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="d540f-106">This article covers how tools for gathering performance traces and collecting dumps can be used in Docker containers.</span></span>

## <a name="using-net-core-cli-tools-in-a-container"></a><span data-ttu-id="d540f-107">コンテナーでの .NET Core CLI ツールの使用</span><span class="sxs-lookup"><span data-stu-id="d540f-107">Using .NET Core CLI tools in a container</span></span>

<span data-ttu-id="d540f-108">**これらのツールの適用対象: ✔️** .NET Core 3.0 SDK 以降のバージョン</span><span class="sxs-lookup"><span data-stu-id="d540f-108">**These tools apply to: ✔️** .NET Core 3.0 SDK and later versions</span></span>

<span data-ttu-id="d540f-109">.NET Core グローバル CLI 診断ツール ([`dotnet-counters`](dotnet-counters.md)、[`dotnet-dump`](dotnet-dump.md)、[`dotnet-gcdump`](dotnet-gcdump.md)、[`dotnet-trace`](dotnet-trace.md)) は、さまざまな環境で動作するように設計されており、Docker コンテナーでもすべて直接動作するはずです。</span><span class="sxs-lookup"><span data-stu-id="d540f-109">The .NET Core global CLI diagnostic tools ([`dotnet-counters`](dotnet-counters.md), [`dotnet-dump`](dotnet-dump.md), [`dotnet-gcdump`](dotnet-gcdump.md), and [`dotnet-trace`](dotnet-trace.md)) are designed to work in a wide variety of environments and should all work directly in Docker containers.</span></span> <span data-ttu-id="d540f-110">このため、これらのツールは、コンテナーでの .NET Core 3.0 以降 (または、`dotnet-gcdump` の場合は 3.1 以降) を対象とする .NET Core のシナリオにおいて診断情報を収集するために推奨される方法です。</span><span class="sxs-lookup"><span data-stu-id="d540f-110">Because of this, these tools are the preferred method of collecting diagnostic information for .NET Core scenarios targeting .NET Core 3.0 or above (or 3.1 or above in the case of `dotnet-gcdump`) in containers.</span></span>

<span data-ttu-id="d540f-111">コンテナーでこれらのツールを使用するときの唯一の複雑な要因は、これらは .NET Core SDK でインストールされますが、多くの Docker コンテナーは .NET Core SDK がなくても実行されることです。</span><span class="sxs-lookup"><span data-stu-id="d540f-111">The only complicating factor of using these tools in a container is that they are installed with the .NET Core SDK and many Docker containers run without the .NET Core SDK present.</span></span> <span data-ttu-id="d540f-112">この問題に対する簡単な解決策の 1 つは、最初の Docker イメージでツールをインストールすることです。</span><span class="sxs-lookup"><span data-stu-id="d540f-112">One easy solution to this problem is to install the tools in the initial Docker image.</span></span> <span data-ttu-id="d540f-113">ツールを使用するのに、.NET Core SDK が実行されている必要はなく、インストールされているだけでかまいません。</span><span class="sxs-lookup"><span data-stu-id="d540f-113">The tools don't need the .NET Core SDK to run, only to be installed.</span></span> <span data-ttu-id="d540f-114">したがって、(.NET Core SDK が存在する) ビルド ステージでツールをインストールした後、バイナリを最終的なイメージにコピーする、[マルチステージ ビルド](https://docs.docker.com/develop/develop-images/multistage-build/)で Dockerfile を作成することができます。</span><span class="sxs-lookup"><span data-stu-id="d540f-114">Therefore, it's possible to create a Dockerfile with a [multi-stage build](https://docs.docker.com/develop/develop-images/multistage-build/) that installs the tools in a build stage (where the .NET Core SDK is present) and then copies the binaries into the final image.</span></span> <span data-ttu-id="d540f-115">この方法の唯一の欠点は、Docker イメージのサイズが増加することです。</span><span class="sxs-lookup"><span data-stu-id="d540f-115">The only downside to this approach is increased Docker image size.</span></span>

```dockerfile
# In build stage
# Install desired .NET CLI diagnostics tools
RUN dotnet tool install --tool-path /tools dotnet-trace
RUN dotnet tool install --tool-path /tools dotnet-counters
RUN dotnet tool install --tool-path /tools dotnet-dump

...

# In final stage
# Copy diagnostics tools
WORKDIR /tools
COPY --from=build /tools .
```

<span data-ttu-id="d540f-116">または、CLI ツールをインストールするために必要になった時点で、コンテナーに .NET Core SDK をインストールすることもできます。</span><span class="sxs-lookup"><span data-stu-id="d540f-116">Alternatively, the .NET Core SDK can be installed in a container when needed in order to install the CLI tools.</span></span> <span data-ttu-id="d540f-117">.NET Core SDK をインストールすると、.NET Core ランタイムが再インストールされるという副作用があることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="d540f-117">Be aware that installing the .NET Core SDK will have the side-effect of reinstalling the .NET Core runtime.</span></span> <span data-ttu-id="d540f-118">そのため、コンテナーに存在するランタイムと一致するバージョンの SDK を必ずインストールしてください。</span><span class="sxs-lookup"><span data-stu-id="d540f-118">So be sure to install the version of the SDK that matches the runtime present in the container.</span></span>

### <a name="using-net-core-global-cli-tools-in-a-sidecar-container"></a><span data-ttu-id="d540f-119">サイドカー コンテナーでの .NET Core グローバル CLI ツールの使用</span><span class="sxs-lookup"><span data-stu-id="d540f-119">Using .NET Core global CLI tools in a sidecar container</span></span>

<span data-ttu-id="d540f-120">.NET Core グローバル CLI 診断ツールを使用して別のコンテナーのプロセスを診断する場合は、次の追加要件を考慮する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d540f-120">If you would like to use .NET Core global CLI diagnostic tools to diagnose processes in a different container, bear the following additional requirements in mind:</span></span>

1. <span data-ttu-id="d540f-121">コンテナーで、[プロセスの名前空間を共有する](https://docs.docker.com/engine/reference/run/#pid-settings---pid)必要があります (サイドカー コンテナー内のツールが、ターゲット コンテナー内のプロセスにアクセスできるようにするため)。</span><span class="sxs-lookup"><span data-stu-id="d540f-121">The containers must [share a process namespace](https://docs.docker.com/engine/reference/run/#pid-settings---pid) (so that tools in the sidecar container can access processes in the target container).</span></span>
2. <span data-ttu-id="d540f-122">.NET Core グローバル CLI 診断ツールを使用するには、.NET Core ランタイムによって /tmp ディレクトリに書き込まれるファイルにアクセスする必要があるため、ターゲット コンテナーとサイドカー コンテナーの間でボリューム マウントを使用して /tmp ディレクトリを共有する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d540f-122">The .NET Core global CLI diagnostic tools need access to files the .NET Core runtime writes to the /tmp directory, so the /tmp directory must be shared between the target and sidecar container via a volume mount.</span></span> <span data-ttu-id="d540f-123">これは、たとえば、コンテナーで共通の[ボリューム](https://docs.docker.com/storage/volumes/#create-and-manage-volumes)または Kubernetes [emptyDir](https://kubernetes.io/docs/concepts/storage/volumes/#emptydir) ボリュームを共有することにより、行うことができます。</span><span class="sxs-lookup"><span data-stu-id="d540f-123">This could be done, for example, by having the containers share a common [volume](https://docs.docker.com/storage/volumes/#create-and-manage-volumes) or a Kubernetes [emptyDir](https://kubernetes.io/docs/concepts/storage/volumes/#emptydir) volume.</span></span> <span data-ttu-id="d540f-124">/tmp ディレクトリを共有せずにサイドカー コンテナーから診断ツールを使用しようとすると、プロセスで "互換性のある .NET ランタイムが実行されていない" というエラーが発生します。</span><span class="sxs-lookup"><span data-stu-id="d540f-124">If you attempt to use the diagnostic tools from a sidecar container without sharing the /tmp directory, you will get an error about the process "not running compatible .NET runtime."</span></span>

## <a name="using-perfcollect-in-a-container"></a><span data-ttu-id="d540f-125">コンテナーでの `PerfCollect` の使用</span><span class="sxs-lookup"><span data-stu-id="d540f-125">Using `PerfCollect` in a container</span></span>

<span data-ttu-id="d540f-126">**このツールの適用対象: ✔️** .NET Core 2.1 以降のバージョン</span><span class="sxs-lookup"><span data-stu-id="d540f-126">**This tool applies to: ✔️** .NET Core 2.1 and later versions</span></span>

<span data-ttu-id="d540f-127">[`PerfCollect`](https://github.com/dotnet/coreclr/blob/master/Documentation/project-docs/linux-performance-tracing.md) スクリプトは、パフォーマンス トレースの収集に役に立ち、.NET Core 3.0 より前のトレースを収集する場合に推奨されるツールです。</span><span class="sxs-lookup"><span data-stu-id="d540f-127">The [`PerfCollect`](https://github.com/dotnet/coreclr/blob/master/Documentation/project-docs/linux-performance-tracing.md) script is useful for collecting performance traces and is the recommended tool for collecting traces prior to .NET Core 3.0.</span></span> <span data-ttu-id="d540f-128">コンテナーで `PerfCollect` を使用する場合は、次の要件を考慮してください。</span><span class="sxs-lookup"><span data-stu-id="d540f-128">If using `PerfCollect` in a container, keep the following requirements in mind:</span></span>

1. <span data-ttu-id="d540f-129">`PerfCollect` を使用するには、[`SYS_ADMIN` 機能](https://man7.org/linux/man-pages/man7/capabilities.7.html)が必要なので (`perf` ツールを実行するため)、コンテナーが[その機能がある状態で開始される](https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities)ことを確認します。</span><span class="sxs-lookup"><span data-stu-id="d540f-129">`PerfCollect` requires the [`SYS_ADMIN` capability](https://man7.org/linux/man-pages/man7/capabilities.7.html) (in order to run the `perf` tool), so be sure the container is [started with that capability](https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities).</span></span>
2. <span data-ttu-id="d540f-130">`PerfCollect` では、プロファイリング対象のアプリが開始するより前に、いくつかの環境変数が設定されている必要があります。</span><span class="sxs-lookup"><span data-stu-id="d540f-130">`PerfCollect` requires some environment variables be set prior to the app it is profiling starting.</span></span> <span data-ttu-id="d540f-131">これらは、[Dockerfile](https://docs.docker.com/engine/reference/builder/#env) で、または[コンテナーを開始する](https://docs.docker.com/engine/reference/run/#env-environment-variables)ときに、設定できます。</span><span class="sxs-lookup"><span data-stu-id="d540f-131">These can be set either in a [Dockerfile](https://docs.docker.com/engine/reference/builder/#env) or when [starting the container](https://docs.docker.com/engine/reference/run/#env-environment-variables).</span></span> <span data-ttu-id="d540f-132">これらの変数は通常の運用環境では設定されないので、プロファイリング対象のコンテナーを開始するときにだけ追加するのが一般的です。</span><span class="sxs-lookup"><span data-stu-id="d540f-132">Because these variables shouldn't be set in normal production environments, it's common to just add them when starting a container that will be profiled.</span></span> <span data-ttu-id="d540f-133">PerfCollect で必要になる 2 つの変数は次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="d540f-133">The two variables which PerfCollect requires are:</span></span>
    1. <span data-ttu-id="d540f-134">COMPlus_PerfMapEnabled=1</span><span class="sxs-lookup"><span data-stu-id="d540f-134">COMPlus_PerfMapEnabled=1</span></span>
    1. <span data-ttu-id="d540f-135">COMPlus_EnableEventLog=1</span><span class="sxs-lookup"><span data-stu-id="d540f-135">COMPlus_EnableEventLog=1</span></span>

### <a name="using-perfcollect-in-a-sidecar-container"></a><span data-ttu-id="d540f-136">サイドカー コンテナーでの `PerfCollect` の使用</span><span class="sxs-lookup"><span data-stu-id="d540f-136">Using `PerfCollect` in a sidecar container</span></span>

<span data-ttu-id="d540f-137">あるコンテナーで `PerfCollect` を実行し、別のコンテナー内の .NET Core プロセスをプロファイリングする場合、エクスペリエンスはほぼ同じですが、次のような違いがあります。</span><span class="sxs-lookup"><span data-stu-id="d540f-137">If you would like to run `PerfCollect` in one container to profile a .NET Core process in a different container, the experience is almost the same except for these differences:</span></span>

1. <span data-ttu-id="d540f-138">前に説明した環境変数 (COMPlus_PerfMapEnabled と COMPlus_EnableEventLog) を、(`PerfCollect` を実行するものではなく) ターゲット コンテナーに対して設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d540f-138">The environment variables mentioned previously (COMPlus_PerfMapEnabled and COMPlus_EnableEventLog) must be set for the target container (not the one running `PerfCollect`).</span></span>
2. <span data-ttu-id="d540f-139">(ターゲット コンテナーではなく) `PerfCollect` を実行するコンテナーに、`SYS_ADMIN` 機能が必要です。</span><span class="sxs-lookup"><span data-stu-id="d540f-139">The container running `PerfCollect` must have the `SYS_ADMIN` capability (not the target container).</span></span>
3. <span data-ttu-id="d540f-140">2 つのコンテナーは、[プロセスの名前空間を共有している](https://docs.docker.com/engine/reference/run/#pid-settings---pid)必要があります。</span><span class="sxs-lookup"><span data-stu-id="d540f-140">The two containers must [share a process namespace](https://docs.docker.com/engine/reference/run/#pid-settings---pid).</span></span>

## <a name="using-createdump-in-a-container"></a><span data-ttu-id="d540f-141">コンテナーでの `createdump` の使用</span><span class="sxs-lookup"><span data-stu-id="d540f-141">Using `createdump` in a container</span></span>

<span data-ttu-id="d540f-142">**このツールの適用対象: ✔️** .NET Core 2.1 以降のバージョン</span><span class="sxs-lookup"><span data-stu-id="d540f-142">**This tool applies to: ✔️** .NET Core 2.1 and later versions</span></span>

<span data-ttu-id="d540f-143">`dotnet-dump` の代わりに、[`createdump`](https://github.com/dotnet/runtime/blob/master/docs/design/coreclr/botr/xplat-minidump-generation.md) を使用して、ネイティブ情報とマネージド情報の両方が含まれるコア ダンプを Linux 上に作成することができます。</span><span class="sxs-lookup"><span data-stu-id="d540f-143">An alternative to `dotnet-dump`, [`createdump`](https://github.com/dotnet/runtime/blob/master/docs/design/coreclr/botr/xplat-minidump-generation.md) can be used for creating core dumps on Linux containing both native and managed information.</span></span> <span data-ttu-id="d540f-144">`createdump` ツールは .NET Core ランタイムと共にインストールされ、libcoreclr.so の隣にあります(通常は、"/usr/share/dotnet/shared/Microsoft.NETCore.App/[バージョン]" 内)。</span><span class="sxs-lookup"><span data-stu-id="d540f-144">The `createdump` tool is installed with the .NET Core runtime and can be found next to libcoreclr.so (typically in "/usr/share/dotnet/shared/Microsoft.NETCore.App/[version]").</span></span> <span data-ttu-id="d540f-145">このツールは、コンテナー内でもコンテナー化されていない Linux 環境と同じように動作しますが、1 つだけ例外があります。それは、ツールには [`SYS_PTRACE` 機能](https://man7.org/linux/man-pages/man7/capabilities.7.html)が必要であるため、Docker コンテナーを[開始するときにその機能を有効にしておく](https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities)必要があるということです。</span><span class="sxs-lookup"><span data-stu-id="d540f-145">The tool works the same in a container as it does in non-containerized Linux environments with the single exception that the tool requires the [`SYS_PTRACE` capability](https://man7.org/linux/man-pages/man7/capabilities.7.html), so the Docker container must be [started with that capability](https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities).</span></span>

### <a name="using-createdump-in-a-sidecar-container"></a><span data-ttu-id="d540f-146">サイドカー コンテナーでの `createdump` の使用</span><span class="sxs-lookup"><span data-stu-id="d540f-146">Using `createdump` in a sidecar container</span></span>

<span data-ttu-id="d540f-147">`createdump` を使用して、異なるコンテナー内のプロセスからダンプを作成したい場合、エクスペリエンスはほぼ同じですが、次のような違いがあります。</span><span class="sxs-lookup"><span data-stu-id="d540f-147">If you would like to use `createdump` to create a dump from a process in a different container, the experience is almost the same except for these differences:</span></span>

1. <span data-ttu-id="d540f-148">(ターゲット コンテナーではなく) `createdump` を実行するコンテナーに、`SYS_PTRACE` 機能が必要です。</span><span class="sxs-lookup"><span data-stu-id="d540f-148">The container running `createdump` must have the `SYS_PTRACE` capability (not the target container).</span></span>
2. <span data-ttu-id="d540f-149">2 つのコンテナーは、[プロセスの名前空間を共有している](https://docs.docker.com/engine/reference/run/#pid-settings---pid)必要があります。</span><span class="sxs-lookup"><span data-stu-id="d540f-149">The two containers must [share a process namespace](https://docs.docker.com/engine/reference/run/#pid-settings---pid).</span></span>
